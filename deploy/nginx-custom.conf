# Forecasto - Plesk Additional nginx directives
# Add this in: Plesk > app.forecasto.it > Apache & nginx Settings > Additional nginx directives

# ---------------------------------------------------------------------------
# MCP OAuth discovery endpoints (RFC 8414 + RFC 9728)
# Claude looks for these at the domain root before starting auth flow
# ---------------------------------------------------------------------------
location /.well-known/oauth-authorization-server {
    proxy_pass http://127.0.0.1:3100/.well-known/oauth-authorization-server;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location ^~ /.well-known/oauth-protected-resource {
    proxy_pass http://127.0.0.1:3100/.well-known/oauth-protected-resource;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ---------------------------------------------------------------------------
# MCP OAuth endpoints at root level (required by MCP spec)
# These are served by the MCP server's mcpAuthRouter
# ---------------------------------------------------------------------------
location = /authorize {
    proxy_pass http://127.0.0.1:3100/authorize;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location = /token {
    proxy_pass http://127.0.0.1:3100/token;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# /register: POST → MCP server (OAuth dynamic client registration, RFC 7591)
#            GET/HEAD/altri metodi → SPA frontend (pagina di registrazione utente)
location = /register {
    if ($request_method != POST) {
        rewrite ^ /index.html last;
    }
    proxy_pass http://127.0.0.1:3100/register;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ---------------------------------------------------------------------------
# MCP Server - Streamable HTTP (long-lived connections)
# ---------------------------------------------------------------------------
location /mcp {
    proxy_pass http://127.0.0.1:3100/mcp;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection '';
    proxy_buffering off;
    proxy_cache off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    chunked_transfer_encoding on;
}

# ---------------------------------------------------------------------------
# FastAPI backend
# ---------------------------------------------------------------------------
location /api/ {
    proxy_pass http://127.0.0.1:8000/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 60s;
}

# MCP OAuth callback — must come before /oauth/ to take precedence
location ^~ /oauth/callback {
    proxy_pass http://127.0.0.1:3100/oauth/callback;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# FastAPI OAuth endpoints (login form, authorize, token)
location /oauth/ {
    proxy_pass http://127.0.0.1:8000/oauth/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /health {
    proxy_pass http://127.0.0.1:8000/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /docs {
    proxy_pass http://127.0.0.1:8000/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /redoc {
    proxy_pass http://127.0.0.1:8000/redoc;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location /openapi.json {
    proxy_pass http://127.0.0.1:8000/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
