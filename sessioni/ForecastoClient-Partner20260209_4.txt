
▗ ▗   ▖ ▖  Claude Code v2.1.37
           Opus 4.6 · API Usage Billing
  ▘▘ ▝▝    ~/dev/forecasto

╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                                                    │
│                                                                                                                      │
│ Piano: Sistema Fatturazione e Report Codici Partner                                                                  │
│                                                                                                                      │
│ Contesto                                                                                                             │
│                                                                                                                      │
│ Dopo l'implementazione del sistema partner (piano precedente, completato), serve un sistema per tracciare la         │
│ fatturazione dei codici attivati. L'admin deve poter:                                                                │
│ 1. Vedere un report dei codici attivati per mese/partner con esportazione                                            │
│ 2. Marcare singoli codici o periodi come fatturati, specificando se fatturati al cliente o al partner                │
│ 3. Avere un secondo report per periodo-partner che mostra lo stato di fatturazione                                   │
│ 4. Distinguere il tipo di partner ("fatturazione a cliente" vs "fatturazione a partner") per pre-impostare il tipo   │
│ di fatturazione dei codici invito                                                                                    │
│ 5. Quando la fattura va al cliente, deve essere riconosciuta una fee al partner                                      │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 1. Backend - Modello e Migrazione                                                                                    │
│                                                                                                                      │
│ 1a. Aggiungere partner_type al modello User                                                                          │
│                                                                                                                      │
│ File: forecasto-server/src/forecasto/models/user.py                                                                  │
│ - Aggiungere campo partner_type: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)                    │
│ - Valori possibili: "billing_to_client" | "billing_to_partner" | None (non partner)                                  │
│                                                                                                                      │
│ 1b. Aggiungere campi fatturazione a RegistrationCode                                                                 │
│                                                                                                                      │
│ File: forecasto-server/src/forecasto/models/registration_code.py                                                     │
│ - invoiced: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False) - se il codice e stato fatturato    │
│ - invoiced_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True) - data fatturazione               │
│ - invoiced_to: Mapped[Optional[str]] = mapped_column(String(20), nullable=True) - "client" o "partner"               │
│ - invoice_note: Mapped[Optional[str]] = mapped_column(String(255), nullable=True) - riferimento fattura opzionale    │
│ - partner_fee_recognized: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False) - se la fee al        │
│ partner e stata riconosciuta (rilevante solo quando invoiced_to == "client")                                         │
│ - partner_fee_recognized_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)                     │
│                                                                                                                      │
│ 1c. Migrazione Alembic 011_add_billing_system.py                                                                     │
│                                                                                                                      │
│ File: forecasto-server/alembic/versions/011_add_billing_system.py                                                    │
│ - Ricreare tabella users con campo partner_type (pattern SQLite: CREATE new, INSERT SELECT, DROP old, RENAME)        │
│ - Ricreare tabella registration_codes con campi fatturazione (stesso pattern SQLite)                                 │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 2. Backend - Schemas                                                                                                 │
│                                                                                                                      │
│ 2a. Schema admin (schemas/admin.py)                                                                                  │
│                                                                                                                      │
│ - Aggiungere a AdminUserResponse: partner_type: str | None = None                                                    │
│ - Aggiungere a RegistrationCodeResponse: invoiced, invoiced_at, invoiced_to, invoice_note, partner_fee_recognized,   │
│ partner_fee_recognized_at                                                                                            │
│ - Nuovo SetPartnerTypeRequest(BaseModel): partner_type: Literal["billing_to_client", "billing_to_partner"]           │
│ - Nuovo InvoiceCodesRequest(BaseModel): code_ids: list[str], invoiced_to: Literal["client", "partner"],              │
│ invoice_note: str | None = None                                                                                      │
│ - Nuovo RecognizeFeeRequest(BaseModel): code_ids: list[str]                                                          │
│ - Nuovo ActivatedCodesReportFilter(BaseModel): partner_id: str | None, month: int | None (1-12), year: int | None,   │
│ invoiced: bool | None (filtro opzionale)                                                                             │
│ - Nuovo ActivatedCodeReportRow(BaseModel): code_id, code, used_at, used_by_name, used_by_email, batch_name,          │
│ partner_id, partner_name, partner_type, invoiced, invoiced_at, invoiced_to, invoice_note, partner_fee_recognized,    │
│ partner_fee_recognized_at                                                                                            │
│ - Nuovo PartnerBillingSummary(BaseModel): partner_id, partner_name, partner_type, total_activated, invoiced_count,   │
│ not_invoiced_count, invoiced_to_client, invoiced_to_partner, fee_recognized_count, fee_pending_count                 │
│                                                                                                                      │
│ 2b. Schema partner (schemas/partner.py)                                                                              │
│                                                                                                                      │
│ - Aggiungere a PartnerCodeResponse: invoiced, invoiced_to (il partner puo vedere se il suo codice e stato fatturato) │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 3. Backend - Service e API                                                                                           │
│                                                                                                                      │
│ 3a. Admin Service (services/admin_service.py)                                                                        │
│                                                                                                                      │
│ Nuovi metodi:                                                                                                        │
│ - set_partner_type(user_id, partner_type) - imposta tipo partner                                                     │
│ - get_activated_codes_report(filters) - report codici attivati con filtri mese/partner/stato fatturazione. Query:    │
│ RegistrationCode con used_at IS NOT NULL, JOIN batch per partner_id, JOIN user per dati partner. Raggruppa per mese  │
│ tramite filtro.                                                                                                      │
│ - invoice_codes(code_ids, invoiced_to, invoice_note) - marca codici come fatturati. Setta invoiced=True,             │
│ invoiced_at=now(), invoiced_to=..., invoice_note=...                                                                 │
│ - recognize_partner_fee(code_ids) - marca fee riconosciuta per codici fatturati a cliente. Setta                     │
│ partner_fee_recognized=True, partner_fee_recognized_at=now(). Validazione: solo codici con invoiced_to="client".     │
│ - get_billing_summary(partner_id, month, year) - sommario fatturazione per periodo-partner: conteggi fatturati/non   │
│ fatturati, divisi per tipo destinatario, fee riconosciute/pendenti.                                                  │
│ - export_activated_codes_csv(filters) - restituisce dati per export CSV (stesso di report ma senza paginazione)      │
│                                                                                                                      │
│ Metodi da aggiornare:                                                                                                │
│ - set_partner() - quando si imposta is_partner=True, impostare anche partner_type (default "billing_to_partner")     │
│ - list_users() / get_user() - includere partner_type nella response                                                  │
│ - get_batch() / list_codes() - includere campi fatturazione nelle response dei codici                                │
│ - list_partner_batches() / get_partner_batch() - includere campi fatturazione visibili al partner                    │
│                                                                                                                      │
│ 3b. Admin API (api/admin.py)                                                                                         │
│                                                                                                                      │
│ - PATCH /admin/users/{user_id}/partner-type - imposta tipo partner (body: SetPartnerTypeRequest)                     │
│ - GET /admin/reports/activated-codes - report codici attivati (query params: partner_id, month, year, invoiced)      │
│ - POST /admin/reports/activated-codes/invoice - marca codici come fatturati (body: InvoiceCodesRequest)              │
│ - POST /admin/reports/activated-codes/recognize-fee - riconosci fee partner (body: RecognizeFeeRequest)              │
│ - GET /admin/reports/billing-summary - sommario fatturazione per periodo-partner (query params: partner_id, month,   │
│ year)                                                                                                                │
│ - GET /admin/reports/activated-codes/export - export CSV codici attivati                                             │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 4. Frontend - Types e API                                                                                            │
│                                                                                                                      │
│ 4a. Types admin (types/admin.ts)                                                                                     │
│                                                                                                                      │
│ - Aggiungere a AdminUser: partner_type: 'billing_to_client' | 'billing_to_partner' | null                            │
│ - Aggiungere a RegistrationCode: invoiced, invoiced_at, invoiced_to, invoice_note, partner_fee_recognized,           │
│ partner_fee_recognized_at                                                                                            │
│ - Nuova interfaccia ActivatedCodeReportRow: tutti i campi del report                                                 │
│ - Nuova interfaccia PartnerBillingSummary: sommario fatturazione                                                     │
│ - Nuova interfaccia InvoiceCodesRequest: code_ids, invoiced_to, invoice_note?                                        │
│                                                                                                                      │
│ 4b. API admin (api/admin.ts)                                                                                         │
│                                                                                                                      │
│ - setPartnerType(userId, partnerType) - PATCH /admin/users/{userId}/partner-type                                     │
│ - getActivatedCodesReport(filters) - GET /admin/reports/activated-codes                                              │
│ - invoiceCodes(data) - POST /admin/reports/activated-codes/invoice                                                   │
│ - recognizePartnerFee(codeIds) - POST /admin/reports/activated-codes/recognize-fee                                   │
│ - getBillingSummary(filters) - GET /admin/reports/billing-summary                                                    │
│ - exportActivatedCodesCSV(filters) - GET /admin/reports/activated-codes/export (restituisce blob)                    │
│                                                                                                                      │
│ 4c. Types partner (api/partner.ts)                                                                                   │
│                                                                                                                      │
│ - Aggiungere a PartnerCode: invoiced: boolean, invoiced_to: string | null                                            │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 5. Frontend - Admin UI                                                                                               │
│                                                                                                                      │
│ 5a. Nuova pagina Report Codici Attivati (pages/admin/ActivatedCodesReportPage.tsx)                                   │
│                                                                                                                      │
│ Nuova pagina admin con:                                                                                              │
│                                                                                                                      │
│ Filtri (top bar):                                                                                                    │
│ - Mese/Anno: Select per mese + Select/input per anno (default: mese corrente)                                        │
│ - Partner: PartnerCombobox (componente esistente) per filtrare per partner specifico                                 │
│ - Stato fatturazione: Select con "Tutti", "Fatturati", "Non fatturati"                                               │
│                                                                                                                      │
│ Tabella principale:                                                                                                  │
│ Colonne: Codice, Data attivazione, Utente (nome + email), Batch, Partner, Tipo Partner, Fatturato, Fatturato a, Nota │
│  fattura, Fee riconosciuta                                                                                           │
│ - Checkbox per selezione multipla righe                                                                              │
│ - Azioni bulk in toolbar sopra tabella:                                                                              │
│   - "Segna come fatturato" -> Dialog con scelta: "A cliente" / "A partner" + campo nota opzionale                    │
│   - "Riconosci fee partner" -> solo per codici fatturati a cliente, marca fee come riconosciuta                      │
│ - Pulsante "Esporta CSV" (export tutti i codici filtrati)                                                            │
│                                                                                                                      │
│ Cards sommario in alto:                                                                                              │
│ - Totale attivati (nel periodo)                                                                                      │
│ - Fatturati                                                                                                          │
│ - Non fatturati                                                                                                      │
│ - Fee da riconoscere (codici fatturati a cliente senza fee riconosciuta)                                             │
│                                                                                                                      │
│ 5b. Nuova pagina Report Fatturazione Partner (pages/admin/BillingSummaryPage.tsx)                                    │
│                                                                                                                      │
│ Secondo report per periodo-partner:                                                                                  │
│                                                                                                                      │
│ Filtri:                                                                                                              │
│ - Mese/Anno                                                                                                          │
│ - Partner (opzionale, se non specificato mostra tutti i partner)                                                     │
│                                                                                                                      │
│ Tabella:                                                                                                             │
│ Colonne: Partner, Tipo Partner, Codici attivati, Fatturati, Non fatturati, Fatt. a cliente, Fatt. a partner, Fee     │
│ riconosciute, Fee pendenti                                                                                           │
│ - Click su riga partner -> espande con dettaglio codici (pattern Collapsible)                                        │
│ - Pulsante "Esporta CSV"                                                                                             │
│                                                                                                                      │
│ 5c. Aggiornare UsersPage (pages/admin/UsersPage.tsx)                                                                 │
│                                                                                                                      │
│ - Nella azione "Promuovi a Partner", aggiungere scelta del tipo partner (dialog con radio: "Fatturazione a cliente"  │
│ / "Fatturazione a partner")                                                                                          │
│ - Mostrare tipo partner nel badge (es. "Partner - Fatt. Cliente" / "Partner - Fatt. Partner")                        │
│ - Azione "Modifica tipo partner" per partner esistenti                                                               │
│                                                                                                                      │
│ 5d. Aggiornare AdminLayout (pages/admin/AdminLayout.tsx)                                                             │
│                                                                                                                      │
│ - Aggiungere voci di menu:                                                                                           │
│   - "Report Attivazioni" (icona: FileBarChart da lucide-react) -> /admin/reports/activations                         │
│   - "Report Fatturazione" (icona: Receipt da lucide-react) -> /admin/reports/billing                                 │
│                                                                                                                      │
│ 5e. Aggiornare RegistrationCodesPage (pages/admin/RegistrationCodesPage.tsx)                                         │
│                                                                                                                      │
│ - Nella tabella codici del batch, aggiungere colonne: Fatturato (badge si/no), Fatturato a, Fee                      │
│ - Questi sono campi read-only in questa vista (la modifica avviene dal report)                                       │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 6. Frontend - Aggiornare Partnership Tab                                                                             │
│                                                                                                                      │
│ 6a. PartnershipTab (components/settings/PartnershipTab.tsx)                                                          │
│                                                                                                                      │
│ - Aggiungere colonne Fatturato e Fatturato a nella tabella codici (read-only per il partner)                         │
│ - Aggiungere statistiche: codici fatturati, non fatturati                                                            │
│                                                                                                                      │
│ ---                                                                                                                  │
│ 7. Routing e Navigazione                                                                                             │
│                                                                                                                      │
│ 7a. Routes (routes/index.tsx)                                                                                        │
│                                                                                                                      │
│ - Aggiungere: { path: 'reports/activations', element: <ActivatedCodesReportPage /> }                                 │
│ - Aggiungere: { path: 'reports/billing', element: <BillingSummaryPage /> }                                           │
│                                                                                                                      │
│ 7b. Export pagine admin (pages/admin/index.ts)                                                                       │
│                                                                                                                      │
│ - Aggiungere export per le 2 nuove pagine                                                                            │
│                                                                                                                      │
│ ---                                                                                                                  │
│ File da modificare/creare                                                                                            │
│                                                                                                                      │
│ Backend (modificare)                                                                                                 │
│                                                                                                                      │
│ 1. forecasto-server/src/forecasto/models/user.py - campo partner_type                                                │
│ 2. forecasto-server/src/forecasto/models/registration_code.py - campi fatturazione                                   │
│ 3. forecasto-server/src/forecasto/schemas/admin.py - nuovi campi, nuovi schemas report                               │
│ 4. forecasto-server/src/forecasto/schemas/partner.py - campi fatturazione                                            │
│ 5. forecasto-server/src/forecasto/services/admin_service.py - metodi report e fatturazione                           │
│ 6. forecasto-server/src/forecasto/api/admin.py - endpoint report e fatturazione                                      │
│                                                                                                                      │
│ Backend (creare)                                                                                                     │
│                                                                                                                      │
│ 7. forecasto-server/alembic/versions/011_add_billing_system.py - migrazione                                          │
│                                                                                                                      │
│ Frontend (modificare)                                                                                                │
│                                                                                                                      │
│ 8. forecasto-client-web/src/types/admin.ts - nuovi tipi e campi                                                      │
│ 9. forecasto-client-web/src/api/admin.ts - nuovi metodi API                                                          │
│ 10. forecasto-client-web/src/api/partner.ts - campi fatturazione                                                     │
│ 11. forecasto-client-web/src/pages/admin/AdminLayout.tsx - voci menu report                                          │
│ 12. forecasto-client-web/src/pages/admin/UsersPage.tsx - tipo partner in promozione                                  │
│ 13. forecasto-client-web/src/pages/admin/RegistrationCodesPage.tsx - colonne fatturazione                            │
│ 14. forecasto-client-web/src/pages/admin/index.ts - export nuove pagine                                              │
│ 15. forecasto-client-web/src/routes/index.tsx - routes report                                                        │
│ 16. forecasto-client-web/src/components/settings/PartnershipTab.tsx - colonne fatturazione                           │
│                                                                                                                      │
│ Frontend (creare)                                                                                                    │
│                                                                                                                      │
│ 17. forecasto-client-web/src/pages/admin/ActivatedCodesReportPage.tsx - report attivazioni                           │
│ 18. forecasto-client-web/src/pages/admin/BillingSummaryPage.tsx - report fatturazione                                │
│                                                                                                                      │
│ ---                                                                                                                  │
│ Componenti e pattern riutilizzati                                                                                    │
│                                                                                                                      │
│ - PartnerCombobox (components/admin/PartnerCombobox.tsx) - selezione partner nei filtri report                       │
│ - Pattern Collapsible per espandere dettagli in BillingSummaryPage                                                   │
│ - Pattern CSV export (Blob + createObjectURL) gia usato in RegistrationCodesPage e PartnershipTab                    │
│ - Pattern tabella + badge usato in tutte le pagine admin esistenti                                                   │
│ - Pattern Dialog per azioni bulk (fatturazione)                                                                      │
│                                                                                                                      │
│ ---                                                                                                                  │
│ Verifica                                                                                                             │
│                                                                                                                      │
│ 1. Migrazione: alembic upgrade head senza errori, dati preservati                                                    │
│ 2. API report: GET /admin/reports/activated-codes?month=2&year=2026 restituisce codici attivati                      │
│ 3. Fatturazione: POST /admin/reports/activated-codes/invoice marca codici, verifica campi                            │
│ 4. Fee: POST /admin/reports/activated-codes/recognize-fee funziona solo su codici fatt. a cliente                    │
│ 5. Tipo partner: PATCH /admin/users/{id}/partner-type imposta tipo, verificare propagazione                          │
│ 6. Frontend: Navigare alle 2 pagine report, filtrare, selezionare codici, fatturare, esportare CSV                   │
│ 7. Partner view: Login come partner, verificare colonne fatturazione visibili ma non modificabili                    │
│ 8. TypeScript: npx tsc --noEmit zero errori                                                                          │
│ 9. Build: npx vite build successo                                                                                    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

⏺ I'll start by reading the existing files to understand the current codebase structure, then implement the plan
  systematically.

⏺ Let me start by reading all the existing files I need to modify.

⏺ Read 6 files (ctrl+o to expand)

⏺ Now let me read the frontend files.

⏺ Read 6 files (ctrl+o to expand)
  ⎿  Loaded CLAUDE.md

⏺ Now let me read the remaining files I need.

⏺ Searched for 2 patterns, read 5 files (ctrl+o to expand)

⏺ Good, I have all the context I need. Let me now implement everything systematically. I'll start with the backend
  models, migration, and schemas, then move to the service/API, and finally the frontend.

  Task 1: Backend Models and Migration

⏺ Update(forecasto-server/src/forecasto/models/user.py)
  ⎿  Added 1 line
      53      # Admin and registration fields
      54      is_admin: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
      55      is_partner: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
      56 +    partner_type: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)                     
      57      is_blocked: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
      58      blocked_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
      59      blocked_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

⏺ Update(forecasto-server/src/forecasto/models/registration_code.py)
  ⎿  Added 1 line, removed 1 line
       6  from datetime import datetime
       7  from typing import TYPE_CHECKING, Optional
       8
       9 -from sqlalchemy import DateTime, ForeignKey, String, Text                                              
       9 +from sqlalchemy import Boolean, DateTime, ForeignKey, String, Text                                     
      10  from sqlalchemy.orm import Mapped, mapped_column, relationship
      11
      12  from forecasto.models.base import Base, TimestampMixin, UUIDMixin

⏺ Update(forecasto-server/src/forecasto/models/registration_code.py)
  ⎿  Added 8 lines
      68      )
      69      revoked_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
      70
      71 +    # Billing fields                                                                                   
      72 +    invoiced: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)                     
      73 +    invoiced_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)                   
      74 +    invoiced_to: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)                      
      75 +    invoice_note: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)                    
      76 +    partner_fee_recognized: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)       
      77 +    partner_fee_recognized_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)     
      78 +                                                                                                       
      79      # Relationships
      80      batch: Mapped["RegistrationCodeBatch"] = relationship(
      81          "RegistrationCodeBatch", back_populates="codes"

⏺ Now create the migration file.

⏺ Write(forecasto-server/alembic/versions/011_add_billing_system.py)
  ⎿  Wrote 217 lines to forecasto-server/alembic/versions/011_add_billing_system.py
     """Add billing system: partner_type on users, billing fields on registration_codes

     Revision ID: 011_add_billing_system
     Revises: 010_add_partner_system
     Create Date: 2026-02-09

     """
     from typing import Sequence, Union

     from alembic import op
     … +207 lines (ctrl+o to expand)

⏺ Task 2: Backend Schemas

⏺ Update(forecasto-server/src/forecasto/schemas/admin.py)
  ⎿  Added 6 lines
      30      used_by_email: str | None = None
      31      used_by_name: str | None = None
      32      revoked_at: datetime | None = None
      33 +    invoiced: bool = False                                                                             
      34 +    invoiced_at: datetime | None = None                                                                
      35 +    invoiced_to: str | None = None                                                                     
      36 +    invoice_note: str | None = None                                                                    
      37 +    partner_fee_recognized: bool = False                                                               
      38 +    partner_fee_recognized_at: datetime | None = None                                                  
      39
      40      model_config = {"from_attributes": True}
      41

⏺ Update(forecasto-server/src/forecasto/schemas/admin.py)
  ⎿  Added 1 line
      93      name: str
      94      is_admin: bool
      95      is_partner: bool
      96 +    partner_type: str | None = None                                                                    
      97      is_blocked: bool
      98      blocked_at: datetime | None = None
      99      blocked_reason: str | None = None

⏺ Now add the new schemas at the end of the file.

⏺ Update(forecasto-server/src/forecasto/schemas/admin.py)
  ⎿  Added 64 lines
      159      is_partner: bool
      160
      161
      162 +class SetPartnerTypeRequest(BaseModel):                                                               
      163 +    """Request to set partner billing type."""                                                        
      164 +                                                                                                      
      165 +    partner_type: Literal["billing_to_client", "billing_to_partner"]                                  
      166 +                                                                                                      
      167 +                                                                                                      
      168 +class InvoiceCodesRequest(BaseModel):                                                                 
      169 +    """Request to mark codes as invoiced."""                                                          
      170 +                                                                                                      
      171 +    code_ids: list[str]                                                                               
      172 +    invoiced_to: Literal["client", "partner"]                                                         
      173 +    invoice_note: str | None = None                                                                   
      174 +                                                                                                      
      175 +                                                                                                      
      176 +class RecognizeFeeRequest(BaseModel):                                                                 
      177 +    """Request to recognize partner fee for codes."""                                                 
      178 +                                                                                                      
      179 +    code_ids: list[str]                                                                               
      180 +                                                                                                      
      181 +                                                                                                      
      182 +class ActivatedCodesReportFilter(BaseModel):                                                          
      183 +    """Filter for activated codes report."""                                                          
      184 +                                                                                                      
      185 +    partner_id: str | None = None                                                                     
      186 +    month: int | None = Field(default=None, ge=1, le=12)                                              
      187 +    year: int | None = None                                                                           
      188 +    invoiced: bool | None = None                                                                      
      189 +                                                                                                      
      190 +                                                                                                      
      191 +class ActivatedCodeReportRow(BaseModel):                                                              
      192 +    """Single row in activated codes report."""                                                       
      193 +                                                                                                      
      194 +    code_id: str                                                                                      
      195 +    code: str                                                                                         
      196 +    used_at: datetime | None = None                                                                   
      197 +    used_by_name: str | None = None                                                                   
      198 +    used_by_email: str | None = None                                                                  
      199 +    batch_name: str | None = None                                                                     
      200 +    partner_id: str | None = None                                                                     
      201 +    partner_name: str | None = None                                                                   
      202 +    partner_type: str | None = None                                                                   
      203 +    invoiced: bool = False                                                                            
      204 +    invoiced_at: datetime | None = None                                                               
      205 +    invoiced_to: str | None = None                                                                    
      206 +    invoice_note: str | None = None                                                                   
      207 +    partner_fee_recognized: bool = False                                                              
      208 +    partner_fee_recognized_at: datetime | None = None                                                 
      209 +                                                                                                      
      210 +                                                                                                      
      211 +class PartnerBillingSummary(BaseModel):                                                               
      212 +    """Billing summary for a partner."""                                                              
      213 +                                                                                                      
      214 +    partner_id: str                                                                                   
      215 +    partner_name: str                                                                                 
      216 +    partner_type: str | None = None                                                                   
      217 +    total_activated: int = 0                                                                          
      218 +    invoiced_count: int = 0                                                                           
      219 +    not_invoiced_count: int = 0                                                                       
      220 +    invoiced_to_client: int = 0                                                                       
      221 +    invoiced_to_partner: int = 0                                                                      
      222 +    fee_recognized_count: int = 0                                                                     
      223 +    fee_pending_count: int = 0                                                                        
      224 +                                                                                                      
      225 +                                                                                                      
      226  class AssignPartnerRequest(BaseModel):
      227      """Request to assign a batch to a partner."""
      228

⏺ Now update partner schema.

⏺ Update(forecasto-server/src/forecasto/schemas/partner.py)
  ⎿  Added 2 lines
      18      used_by_name: str | None = None
      19      used_by_email: str | None = None
      20      revoked_at: datetime | None = None
      21 +    invoiced: bool = False                                                                             
      22 +    invoiced_to: str | None = None                                                                     
      23
      24
      25  class PartnerBatchResponse(BaseModel):

⏺ Task 3: Backend Service and API

  First, update the admin service with new methods and update existing ones to include the new fields.

⏺ Read 1 file (ctrl+o to expand)

⏺ Now I need to rewrite the admin service with all the updates. Let me make the targeted edits:

  1. Update imports
  2. Update list_users/get_user to include partner_type
  3. Update set_partner to set default partner_type
  4. Update get_batch to include billing fields in codes
  5. Update list_codes/get_code to include billing fields
  6. Update partner batches to include billing fields
  7. Add new billing methods

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 3 lines
      20  )
      21  from forecasto.models.user import User
      22  from forecasto.schemas.admin import (
      23 +    ActivatedCodeReportRow,                                                                            
      24 +    ActivatedCodesReportFilter,                                                                        
      25      AdminUserResponse,
      26      BatchResponse,
      27      BatchWithCodesResponse,
      28      CodeFilter,
      29      CreateBatchRequest,
      30 +    PartnerBillingSummary,                                                                             
      31      RegistrationCodeResponse,
      32      UserFilter,
      33  )

⏺ Now update get_batch to include billing fields in code responses:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 6 lines
      189                      used_by_email=used_by_email,
      190                      used_by_name=used_by_name,
      191                      revoked_at=code.revoked_at,
      192 +                    invoiced=code.invoiced,                                                           
      193 +                    invoiced_at=code.invoiced_at,                                                     
      194 +                    invoiced_to=code.invoiced_to,                                                     
      195 +                    invoice_note=code.invoice_note,                                                   
      196 +                    partner_fee_recognized=code.partner_fee_recognized,                               
      197 +                    partner_fee_recognized_at=code.partner_fee_recognized_at,                         
      198                  )
      199              )
      200

⏺ Now update list_codes to include billing fields:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 6 lines
      284                      used_by_email=used_by_email,
      285                      used_by_name=used_by_name,
      286                      revoked_at=code.revoked_at,
      287 +                    invoiced=code.invoiced,                                                           
      288 +                    invoiced_at=code.invoiced_at,                                                     
      289 +                    invoiced_to=code.invoiced_to,                                                     
      290 +                    invoice_note=code.invoice_note,                                                   
      291 +                    partner_fee_recognized=code.partner_fee_recognized,                               
      292 +                    partner_fee_recognized_at=code.partner_fee_recognized_at,                         
      293                  )
      294              )
      295

⏺ Now update get_code to include billing fields:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 6 lines
      325              used_by_email=used_by_email,
      326              used_by_name=used_by_name,
      327              revoked_at=code.revoked_at,
      328 +            invoiced=code.invoiced,                                                                   
      329 +            invoiced_at=code.invoiced_at,                                                             
      330 +            invoiced_to=code.invoiced_to,                                                             
      331 +            invoice_note=code.invoice_note,                                                           
      332 +            partner_fee_recognized=code.partner_fee_recognized,                                       
      333 +            partner_fee_recognized_at=code.partner_fee_recognized_at,                                 
      334          )
      335
      336      async def revoke_code(self, code_id: str) -> RegistrationCodeResponse:

⏺ Now update list_users and get_user to include partner_type:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 1 line
      440                      name=user.name,
      441                      is_admin=user.is_admin,
      442                      is_partner=user.is_partner,
      443 +                    partner_type=user.partner_type,                                                   
      444                      is_blocked=user.is_blocked,
      445                      blocked_at=user.blocked_at,
      446                      blocked_reason=user.blocked_reason,

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 1 line
      477              name=user.name,
      478              is_admin=user.is_admin,
      479              is_partner=user.is_partner,
      480 +            partner_type=user.partner_type,                                                           
      481              is_blocked=user.is_blocked,
      482              blocked_at=user.blocked_at,
      483              blocked_reason=user.blocked_reason,

⏺ Now update set_partner to set partner_type default:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 21 lines
      503              raise ForbiddenException("Cannot set partner role on an admin user")
      504
      505          user.is_partner = is_partner
      506 +        if is_partner and not user.partner_type:                                                      
      507 +            user.partner_type = "billing_to_partner"                                                  
      508 +        elif not is_partner:                                                                          
      509 +            user.partner_type = None                                                                  
      510          await self.db.flush()
      511
      512          return await self.get_user(user_id)
      513
      514 +    async def set_partner_type(                                                                       
      515 +        self, user_id: str, partner_type: str                                                         
      516 +    ) -> AdminUserResponse:                                                                           
      517 +        """Set the billing type for a partner."""                                                     
      518 +        result = await self.db.execute(select(User).where(User.id == user_id))                        
      519 +        user = result.scalar_one_or_none()                                                            
      520 +        if not user:                                                                                  
      521 +            raise NotFoundException(f"User {user_id} not found")                                      
      522 +                                                                                                      
      523 +        if not user.is_partner:                                                                       
      524 +            raise ValidationException("L'utente non e un partner")                                    
      525 +                                                                                                      
      526 +        user.partner_type = partner_type                                                              
      527 +        await self.db.flush()                                                                         
      528 +                                                                                                      
      529 +        return await self.get_user(user_id)                                                           
      530 +                                                                                                      
      531      async def assign_batch_to_partner(
      532          self, batch_id: str, partner_id: str
      533      ) -> BatchWithCodesResponse:

⏺ Now update partner batch methods to include billing fields:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 2 lines
      593                          used_by_name=used_by_name,
      594                          used_by_email=used_by_email,
      595                          revoked_at=code.revoked_at,
      596 +                        invoiced=code.invoiced,                                                       
      597 +                        invoiced_to=code.invoiced_to,                                                 
      598                      )
      599                  )
      600

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 2 lines
      658                      used_by_name=used_by_name,
      659                      used_by_email=used_by_email,
      660                      revoked_at=code.revoked_at,
      661 +                    invoiced=code.invoiced,                                                           
      662 +                    invoiced_to=code.invoiced_to,                                                     
      663                  )
      664              )
      665

⏺ Now add the new billing/report methods at the end of the service:

⏺ Update(forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 284 lines
      710          await self.db.flush()
      711
      712          return await self.get_user(user_id)
      713 +                                                                                                      
      714 +    # --- Billing / Report methods ---                                                                
      715 +                                                                                                      
      716 +    async def get_activated_codes_report(                                                             
      717 +        self, filters: ActivatedCodesReportFilter                                                     
      718 +    ) -> list[ActivatedCodeReportRow]:                                                                
      719 +        """Get report of activated codes with optional filters."""                                    
      720 +        query = (                                                                                     
      721 +            select(                                                                                   
      722 +                RegistrationCode,                                                                     
      723 +                RegistrationCodeBatch.name.label("batch_name"),                                       
      724 +                RegistrationCodeBatch.partner_id.label("partner_id"),                                 
      725 +            )                                                                                         
      726 +            .join(RegistrationCodeBatch, RegistrationCode.batch_id == RegistrationCodeBatch.id)       
      727 +            .where(RegistrationCode.used_at.isnot(None))                                              
      728 +        )                                                                                             
      729 +                                                                                                      
      730 +        if filters.partner_id:                                                                        
      731 +            query = query.where(RegistrationCodeBatch.partner_id == filters.partner_id)               
      732 +                                                                                                      
      733 +        if filters.month and filters.year:                                                            
      734 +            from calendar import monthrange                                                           
      735 +                                                                                                      
      736 +            start = datetime(filters.year, filters.month, 1)                                          
      737 +            _, last_day = monthrange(filters.year, filters.month)                                     
      738 +            end = datetime(filters.year, filters.month, last_day, 23, 59, 59)                         
      739 +            query = query.where(                                                                      
      740 +                RegistrationCode.used_at >= start,                                                    
      741 +                RegistrationCode.used_at <= end,                                                      
      742 +            )                                                                                         
      743 +        elif filters.year:                                                                            
      744 +            start = datetime(filters.year, 1, 1)                                                      
      745 +            end = datetime(filters.year, 12, 31, 23, 59, 59)                                          
      746 +            query = query.where(                                                                      
      747 +                RegistrationCode.used_at >= start,                                                    
      748 +                RegistrationCode.used_at <= end,                                                      
      749 +            )                                                                                         
      750 +                                                                                                      
      751 +        if filters.invoiced is not None:                                                              
      752 +            query = query.where(RegistrationCode.invoiced == filters.invoiced)                        
      753 +                                                                                                      
      754 +        query = query.order_by(RegistrationCode.used_at.desc())                                       
      755 +        result = await self.db.execute(query)                                                         
      756 +        rows = result.all()                                                                           
      757 +                                                                                                      
      758 +        report = []                                                                                   
      759 +        for row in rows:                                                                              
      760 +            code = row[0]                                                                             
      761 +            batch_name = row[1]                                                                       
      762 +            partner_id = row[2]                                                                       
      763 +                                                                                                      
      764 +            # Resolve user info                                                                       
      765 +            used_by_name = None                                                                       
      766 +            used_by_email = None                                                                      
      767 +            if code.used_by_id:                                                                       
      768 +                user_result = await self.db.execute(                                                  
      769 +                    select(User).where(User.id == code.used_by_id)                                    
      770 +                )                                                                                     
      771 +                u = user_result.scalar_one_or_none()                                                  
      772 +                if u:                                                                                 
      773 +                    used_by_name = u.name                                                             
      774 +                    used_by_email = u.email                                                           
      775 +                                                                                                      
      776 +            # Resolve partner info                                                                    
      777 +            partner_name = None                                                                       
      778 +            partner_type = None                                                                       
      779 +            if partner_id:                                                                            
      780 +                partner_result = await self.db.execute(                                               
      781 +                    select(User).where(User.id == partner_id)                                         
      782 +                )                                                                                     
      783 +                p = partner_result.scalar_one_or_none()                                               
      784 +                if p:                                                                                 
      785 +                    partner_name = p.name                                                             
      786 +                    partner_type = p.partner_type                                                     
      787 +                                                                                                      
      788 +            report.append(                                                                            
      789 +                ActivatedCodeReportRow(                                                               
      790 +                    code_id=code.id,                                                                  
      791 +                    code=code.code,                                                                   
      792 +                    used_at=code.used_at,                                                             
      793 +                    used_by_name=used_by_name,                                                        
      794 +                    used_by_email=used_by_email,                                                      
      795 +                    batch_name=batch_name,                                                            
      796 +                    partner_id=partner_id,                                                            
      797 +                    partner_name=partner_name,                                                        
      798 +                    partner_type=partner_type,                                                        
      799 +                    invoiced=code.invoiced,                                                           
      800 +                    invoiced_at=code.invoiced_at,                                                     
      801 +                    invoiced_to=code.invoiced_to,                                                     
      802 +                    invoice_note=code.invoice_note,                                                   
      803 +                    partner_fee_recognized=code.partner_fee_recognized,                               
      804 +                    partner_fee_recognized_at=code.partner_fee_recognized_at,                         
      805 +                )                                                                                     
      806 +            )                                                                                         
      807 +                                                                                                      
      808 +        return report                                                                                 
      809 +                                                                                                      
      810 +    async def invoice_codes(                                                                          
      811 +        self, code_ids: list[str], invoiced_to: str, invoice_note: str | None                         
      812 +    ) -> int:                                                                                         
      813 +        """Mark codes as invoiced. Returns the number of codes updated."""                            
      814 +        now = datetime.utcnow()                                                                       
      815 +        count = 0                                                                                     
      816 +        for code_id in code_ids:                                                                      
      817 +            result = await self.db.execute(                                                           
      818 +                select(RegistrationCode).where(RegistrationCode.id == code_id)                        
      819 +            )                                                                                         
      820 +            code = result.scalar_one_or_none()                                                        
      821 +            if not code:                                                                              
      822 +                continue                                                                              
      823 +            if code.invoiced:                                                                         
      824 +                continue                                                                              
      825 +            code.invoiced = True                                                                      
      826 +            code.invoiced_at = now                                                                    
      827 +            code.invoiced_to = invoiced_to                                                            
      828 +            code.invoice_note = invoice_note                                                          
      829 +            count += 1                                                                                
      830 +                                                                                                      
      831 +        await self.db.flush()                                                                         
      832 +        return count                                                                                  
      833 +                                                                                                      
      834 +    async def recognize_partner_fee(self, code_ids: list[str]) -> int:                                
      835 +        """Recognize partner fee for codes invoiced to client. Returns count updated."""              
      836 +        now = datetime.utcnow()                                                                       
      837 +        count = 0                                                                                     
      838 +        for code_id in code_ids:                                                                      
      839 +            result = await self.db.execute(                                                           
      840 +                select(RegistrationCode).where(RegistrationCode.id == code_id)                        
      841 +            )                                                                                         
      842 +            code = result.scalar_one_or_none()                                                        
      843 +            if not code:                                                                              
      844 +                continue                                                                              
      845 +            if code.invoiced_to != "client":                                                          
      846 +                continue                                                                              
      847 +            if code.partner_fee_recognized:                                                           
      848 +                continue                                                                              
      849 +            code.partner_fee_recognized = True                                                        
      850 +            code.partner_fee_recognized_at = now                                                      
      851 +            count += 1                                                                                
      852 +                                                                                                      
      853 +        await self.db.flush()                                                                         
      854 +        return count                                                                                  
      855 +                                                                                                      
      856 +    async def get_billing_summary(                                                                    
      857 +        self, partner_id: str | None, month: int | None, year: int | None                             
      858 +    ) -> list[PartnerBillingSummary]:                                                                 
      859 +        """Get billing summary grouped by partner."""                                                 
      860 +        # Get all partner batches with activated codes                                                
      861 +        query = (                                                                                     
      862 +            select(                                                                                   
      863 +                RegistrationCodeBatch.partner_id,                                                     
      864 +            )                                                                                         
      865 +            .join(RegistrationCode, RegistrationCode.batch_id == RegistrationCodeBatch.id)            
      866 +            .where(                                                                                   
      867 +                RegistrationCode.used_at.isnot(None),                                                 
      868 +                RegistrationCodeBatch.partner_id.isnot(None),                                         
      869 +            )                                                                                         
      870 +        )                                                                                             
      871 +                                                                                                      
      872 +        if partner_id:                                                                                
      873 +            query = query.where(RegistrationCodeBatch.partner_id == partner_id)                       
      874 +                                                                                                      
      875 +        if month and year:                                                                            
      876 +            from calendar import monthrange                                                           
      877 +                                                                                                      
      878 +            start = datetime(year, month, 1)                                                          
      879 +            _, last_day = monthrange(year, month)                                                     
      880 +            end = datetime(year, month, last_day, 23, 59, 59)                                         
      881 +            query = query.where(                                                                      
      882 +                RegistrationCode.used_at >= start,                                                    
      883 +                RegistrationCode.used_at <= end,                                                      
      884 +            )                                                                                         
      885 +        elif year:                                                                                    
      886 +            start = datetime(year, 1, 1)                                                              
      887 +            end = datetime(year, 12, 31, 23, 59, 59)                                                  
      888 +            query = query.where(                                                                      
      889 +                RegistrationCode.used_at >= start,                                                    
      890 +                RegistrationCode.used_at <= end,                                                      
      891 +            )                                                                                         
      892 +                                                                                                      
      893 +        query = query.group_by(RegistrationCodeBatch.partner_id)                                      
      894 +        result = await self.db.execute(query)                                                         
      895 +        partner_ids_rows = result.all()                                                               
      896 +                                                                                                      
      897 +        summaries = []                                                                                
      898 +        for row in partner_ids_rows:                                                                  
      899 +            pid = row[0]                                                                              
      900 +                                                                                                      
      901 +            # Get partner info                                                                        
      902 +            partner_result = await self.db.execute(                                                   
      903 +                select(User).where(User.id == pid)                                                    
      904 +            )                                                                                         
      905 +            partner = partner_result.scalar_one_or_none()                                             
      906 +            if not partner:                                                                           
      907 +                continue                                                                              
      908 +                                                                                                      
      909 +            # Build stats query for this partner                                                      
      910 +            codes_query = (                                                                           
      911 +                select(RegistrationCode)                                                              
      912 +                .join(RegistrationCodeBatch, RegistrationCode.batch_id == RegistrationCodeBatch.id)   
      913 +                .where(                                                                               
      914 +                    RegistrationCode.used_at.isnot(None),                                             
      915 +                    RegistrationCodeBatch.partner_id == pid,                                          
      916 +                )                                                                                     
      917 +            )                                                                                         
      918 +                                                                                                      
      919 +            if month and year:                                                                        
      920 +                from calendar import monthrange                                                       
      921 +                                                                                                      
      922 +                start = datetime(year, month, 1)                                                      
      923 +                _, last_day = monthrange(year, month)                                                 
      924 +                end = datetime(year, month, last_day, 23, 59, 59)                                     
      925 +                codes_query = codes_query.where(                                                      
      926 +                    RegistrationCode.used_at >= start,                                                
      927 +                    RegistrationCode.used_at <= end,                                                  
      928 +                )                                                                                     
      929 +            elif year:                                                                                
      930 +                start = datetime(year, 1, 1)                                                          
      931 +                end = datetime(year, 12, 31, 23, 59, 59)                                              
      932 +                codes_query = codes_query.where(                                                      
      933 +                    RegistrationCode.used_at >= start,                                                
      934 +                    RegistrationCode.used_at <= end,                                                  
      935 +                )                                                                                     
      936 +                                                                                                      
      937 +            codes_result = await self.db.execute(codes_query)                                         
      938 +            codes = codes_result.scalars().all()                                                      
      939 +                                                                                                      
      940 +            total = len(codes)                                                                        
      941 +            invoiced_count = sum(1 for c in codes if c.invoiced)                                      
      942 +            not_invoiced = total - invoiced_count                                                     
      943 +            to_client = sum(1 for c in codes if c.invoiced and c.invoiced_to == "client")             
      944 +            to_partner = sum(1 for c in codes if c.invoiced and c.invoiced_to == "partner")           
      945 +            fee_recognized = sum(1 for c in codes if c.partner_fee_recognized)                        
      946 +            fee_pending = sum(                                                                        
      947 +                1 for c in codes                                                                      
      948 +                if c.invoiced and c.invoiced_to == "client" and not c.partner_fee_recognized          
      949 +            )                                                                                         
      950 +                                                                                                      
      951 +            summaries.append(                                                                         
      952 +                PartnerBillingSummary(                                                                
      953 +                    partner_id=pid,                                                                   
      954 +                    partner_name=partner.name,                                                        
      955 +                    partner_type=partner.partner_type,                                                
      956 +                    total_activated=total,                                                            
      957 +                    invoiced_count=invoiced_count,                                                    
      958 +                    not_invoiced_count=not_invoiced,                                                  
      959 +                    invoiced_to_client=to_client,                                                     
      960 +                    invoiced_to_partner=to_partner,                                                   
      961 +                    fee_recognized_count=fee_recognized,                                              
      962 +                    fee_pending_count=fee_pending,                                                    
      963 +                )                                                                                     
      964 +            )                                                                                         
      965 +                                                                                                      
      966 +        return summaries                                                                              
      967 +                                                                                                      
      968 +    async def export_activated_codes_csv(                                                             
      969 +        self, filters: ActivatedCodesReportFilter                                                     
      970 +    ) -> str:                                                                                         
      971 +        """Export activated codes report as CSV string."""                                            
      972 +        rows = await self.get_activated_codes_report(filters)                                         
      973 +                                                                                                      
      974 +        lines = [                                                                                     
      975 +            "Codice,Data Attivazione,Utente,Email,Batch,Partner,Tipo Partner,"                        
      976 +            "Fatturato,Fatturato a,Nota Fattura,Fee Riconosciuta"                                     
      977 +        ]                                                                                             
      978 +        for r in rows:                                                                                
      979 +            used_at_str = r.used_at.strftime("%d/%m/%Y %H:%M") if r.used_at else ""                   
      980 +            invoiced_str = "Si" if r.invoiced else "No"                                               
      981 +            fee_str = "Si" if r.partner_fee_recognized else "No"                                      
      982 +            partner_type_label = ""                                                                   
      983 +            if r.partner_type == "billing_to_client":                                                 
      984 +                partner_type_label = "Fatt. Cliente"                                                  
      985 +            elif r.partner_type == "billing_to_partner":                                              
      986 +                partner_type_label = "Fatt. Partner"                                                  
      987 +                                                                                                      
      988 +            lines.append(                                                                             
      989 +                f"{r.code},{used_at_str},{r.used_by_name or '-'},"                                    
      990 +                f"{r.used_by_email or '-'},{r.batch_name or '-'},"                                    
      991 +                f"{r.partner_name or '-'},{partner_type_label},"                                      
      992 +                f"{invoiced_str},{r.invoiced_to or '-'},"                                             
      993 +                f"{r.invoice_note or '-'},{fee_str}"                                                  
      994 +            )                                                                                         
      995 +                                                                                                      
      996 +        return "\n".join(lines)                                                                       

⏺ Now update the admin API with new endpoints:

⏺ Update(forecasto-server/src/forecasto/api/admin.py)
  ⎿  Added 1 line
       5  from typing import Annotated
       6
       7  from fastapi import APIRouter, Depends, Query
       8 +from fastapi.responses import StreamingResponse                                                        
       9  from sqlalchemy.ext.asyncio import AsyncSession
      10
      11  from forecasto.database import get_db

⏺ Update(forecasto-server/src/forecasto/api/admin.py)
  ⎿  Added 4 lines
      12  from forecasto.dependencies import require_admin
      13  from forecasto.models.user import User
      14  from forecasto.schemas.admin import (
      15 +    ActivatedCodesReportFilter,                                                                        
      16      AdminUserListResponse,
      17      AdminUserResponse,
      18      AssignPartnerRequest,
     ...
      21      CodeFilter,
      22      CodeListResponse,
      23      CreateBatchRequest,
      24 +    InvoiceCodesRequest,                                                                               
      25 +    RecognizeFeeRequest,                                                                               
      26      RegistrationCodeResponse,
      27      SetPartnerRequest,
      28 +    SetPartnerTypeRequest,                                                                             
      29      UserFilter,
      30      ValidateCodeRequest,
      31      ValidateCodeResponse,

⏺ Now add the new endpoints at the end of the file:

⏺ Update(forecasto-server/src/forecasto/api/admin.py)
  ⎿  Added 106 lines
      234      service = AdminService(db)
      235      batch = await service.assign_batch_to_partner(batch_id, data.partner_id)
      236      return {"success": True, "batch": batch}
      237 +                                                                                                      
      238 +                                                                                                      
      239 +# Partner Type Endpoint                                                                               
      240 +                                                                                                      
      241 +                                                                                                      
      242 +@router.patch("/users/{user_id}/partner-type", response_model=dict)                                   
      243 +async def set_partner_type(                                                                           
      244 +    user_id: str,                                                                                     
      245 +    data: SetPartnerTypeRequest,                                                                      
      246 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      247 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      248 +):                                                                                                    
      249 +    """Set the billing type for a partner."""                                                         
      250 +    service = AdminService(db)                                                                        
      251 +    user = await service.set_partner_type(user_id, data.partner_type)                                 
      252 +    return {"success": True, "user": user}                                                            
      253 +                                                                                                      
      254 +                                                                                                      
      255 +# Report and Billing Endpoints                                                                        
      256 +                                                                                                      
      257 +                                                                                                      
      258 +@router.get("/reports/activated-codes", response_model=dict)                                          
      259 +async def get_activated_codes_report(                                                                 
      260 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      261 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      262 +    partner_id: str | None = Query(None),                                                             
      263 +    month: int | None = Query(None, ge=1, le=12),                                                     
      264 +    year: int | None = Query(None),                                                                   
      265 +    invoiced: bool | None = Query(None),                                                              
      266 +):                                                                                                    
      267 +    """Get report of activated codes."""                                                              
      268 +    filters = ActivatedCodesReportFilter(                                                             
      269 +        partner_id=partner_id,                                                                        
      270 +        month=month,                                                                                  
      271 +        year=year,                                                                                    
      272 +        invoiced=invoiced,                                                                            
      273 +    )                                                                                                 
      274 +    service = AdminService(db)                                                                        
      275 +    rows = await service.get_activated_codes_report(filters)                                          
      276 +    return {"success": True, "rows": rows}                                                            
      277 +                                                                                                      
      278 +                                                                                                      
      279 +@router.post("/reports/activated-codes/invoice", response_model=dict)                                 
      280 +async def invoice_codes(                                                                              
      281 +    data: InvoiceCodesRequest,                                                                        
      282 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      283 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      284 +):                                                                                                    
      285 +    """Mark codes as invoiced."""                                                                     
      286 +    service = AdminService(db)                                                                        
      287 +    count = await service.invoice_codes(data.code_ids, data.invoiced_to, data.invoice_note)           
      288 +    return {"success": True, "updated": count}                                                        
      289 +                                                                                                      
      290 +                                                                                                      
      291 +@router.post("/reports/activated-codes/recognize-fee", response_model=dict)                           
      292 +async def recognize_partner_fee(                                                                      
      293 +    data: RecognizeFeeRequest,                                                                        
      294 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      295 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      296 +):                                                                                                    
      297 +    """Recognize partner fee for codes invoiced to client."""                                         
      298 +    service = AdminService(db)                                                                        
      299 +    count = await service.recognize_partner_fee(data.code_ids)                                        
      300 +    return {"success": True, "updated": count}                                                        
      301 +                                                                                                      
      302 +                                                                                                      
      303 +@router.get("/reports/billing-summary", response_model=dict)                                          
      304 +async def get_billing_summary(                                                                        
      305 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      306 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      307 +    partner_id: str | None = Query(None),                                                             
      308 +    month: int | None = Query(None, ge=1, le=12),                                                     
      309 +    year: int | None = Query(None),                                                                   
      310 +):                                                                                                    
      311 +    """Get billing summary per partner."""                                                            
      312 +    service = AdminService(db)                                                                        
      313 +    summaries = await service.get_billing_summary(partner_id, month, year)                            
      314 +    return {"success": True, "summaries": summaries}                                                  
      315 +                                                                                                      
      316 +                                                                                                      
      317 +@router.get("/reports/activated-codes/export")                                                        
      318 +async def export_activated_codes_csv(                                                                 
      319 +    admin_user: Annotated[User, Depends(require_admin)],                                              
      320 +    db: Annotated[AsyncSession, Depends(get_db)],                                                     
      321 +    partner_id: str | None = Query(None),                                                             
      322 +    month: int | None = Query(None, ge=1, le=12),                                                     
      323 +    year: int | None = Query(None),                                                                   
      324 +    invoiced: bool | None = Query(None),                                                              
      325 +):                                                                                                    
      326 +    """Export activated codes as CSV."""                                                              
      327 +    filters = ActivatedCodesReportFilter(                                                             
      328 +        partner_id=partner_id,                                                                        
      329 +        month=month,                                                                                  
      330 +        year=year,                                                                                    
      331 +        invoiced=invoiced,                                                                            
      332 +    )                                                                                                 
      333 +    service = AdminService(db)                                                                        
      334 +    csv_content = await service.export_activated_codes_csv(filters)                                   
      335 +                                                                                                      
      336 +    import io                                                                                         
      337 +                                                                                                      
      338 +    return StreamingResponse(                                                                         
      339 +        io.StringIO(csv_content),                                                                     
      340 +        media_type="text/csv",                                                                        
      341 +        headers={"Content-Disposition": "attachment; filename=report_attivazioni.csv"},               
      342 +    )                                                                                                 

⏺ Task 4: Frontend Types and API functions

⏺ Update(forecasto-client-web/src/types/admin.ts)
  ⎿  Added 6 lines
      10    used_by_email: string | null
      11    used_by_name: string | null
      12    revoked_at: string | null
      13 +  invoiced: boolean                                                                                    
      14 +  invoiced_at: string | null                                                                           
      15 +  invoiced_to: string | null                                                                           
      16 +  invoice_note: string | null                                                                          
      17 +  partner_fee_recognized: boolean                                                                      
      18 +  partner_fee_recognized_at: string | null                                                             
      19  }
      20
      21  export interface RegistrationCodeBatch {

⏺ Update(forecasto-client-web/src/types/admin.ts)
  ⎿  Added 1 line
      72    name: string
      73    is_admin: boolean
      74    is_partner: boolean
      75 +  partner_type: 'billing_to_client' | 'billing_to_partner' | null                                      
      76    is_blocked: boolean
      77    blocked_at: string | null
      78    blocked_reason: string | null

⏺ Now add new interfaces at the end of the file:

⏺ Update(forecasto-client-web/src/types/admin.ts)
  ⎿  Added 50 lines
       92  export interface BlockUserRequest {
       93    reason: string | null
       94  }
       95 +                                                                                                      
       96 +export interface ActivatedCodeReportRow {                                                             
       97 +  code_id: string                                                                                     
       98 +  code: string                                                                                        
       99 +  used_at: string | null                                                                              
      100 +  used_by_name: string | null                                                                         
      101 +  used_by_email: string | null                                                                        
      102 +  batch_name: string | null                                                                           
      103 +  partner_id: string | null                                                                           
      104 +  partner_name: string | null                                                                         
      105 +  partner_type: string | null                                                                         
      106 +  invoiced: boolean                                                                                   
      107 +  invoiced_at: string | null                                                                          
      108 +  invoiced_to: string | null                                                                          
      109 +  invoice_note: string | null                                                                         
      110 +  partner_fee_recognized: boolean                                                                     
      111 +  partner_fee_recognized_at: string | null                                                            
      112 +}                                                                                                     
      113 +                                                                                                      
      114 +export interface PartnerBillingSummary {                                                              
      115 +  partner_id: string                                                                                  
      116 +  partner_name: string                                                                                
      117 +  partner_type: string | null                                                                         
      118 +  total_activated: number                                                                             
      119 +  invoiced_count: number                                                                              
      120 +  not_invoiced_count: number                                                                          
      121 +  invoiced_to_client: number                                                                          
      122 +  invoiced_to_partner: number                                                                         
      123 +  fee_recognized_count: number                                                                        
      124 +  fee_pending_count: number                                                                           
      125 +}                                                                                                     
      126 +                                                                                                      
      127 +export interface InvoiceCodesRequest {                                                                
      128 +  code_ids: string[]                                                                                  
      129 +  invoiced_to: 'client' | 'partner'                                                                   
      130 +  invoice_note?: string | null                                                                        
      131 +}                                                                                                     
      132 +                                                                                                      
      133 +export interface ActivatedCodesReportFilter {                                                         
      134 +  partner_id?: string                                                                                 
      135 +  month?: number                                                                                      
      136 +  year?: number                                                                                       
      137 +  invoiced?: boolean                                                                                  
      138 +}                                                                                                     
      139 +                                                                                                      
      140 +export interface BillingSummaryFilter {                                                               
      141 +  partner_id?: string                                                                                 
      142 +  month?: number                                                                                      
      143 +  year?: number                                                                                       
      144 +}                                                                                                     

⏺ Now update the admin API client:

⏺ Update(forecasto-client-web/src/api/admin.ts)
  ⎿  Added 5 lines
       1  import apiClient from './client'
       2  import type {
       3 +  ActivatedCodeReportRow,                                                                              
       4 +  ActivatedCodesReportFilter,                                                                          
       5    AdminUser,
       6 +  BillingSummaryFilter,                                                                                
       7    BlockUserRequest,
       8    CodeFilter,
       9    CreateBatchRequest,
      10 +  InvoiceCodesRequest,                                                                                 
      11 +  PartnerBillingSummary,                                                                               
      12    RegistrationCode,
      13    RegistrationCodeBatch,
      14    RegistrationCodeBatchWithCodes,

⏺ Add new response interfaces and API methods:

⏺ Update(forecasto-client-web/src/api/admin.ts)
  ⎿  Added 20 lines
      53    validation: ValidateCodeResponse
      54  }
      55
      56 +interface ActivatedCodesReportResponse {                                                               
      57 +  success: boolean                                                                                     
      58 +  rows: ActivatedCodeReportRow[]                                                                       
      59 +}                                                                                                      
      60 +                                                                                                       
      61 +interface BillingSummaryResponse {                                                                     
      62 +  success: boolean                                                                                     
      63 +  summaries: PartnerBillingSummary[]                                                                   
      64 +}                                                                                                      
      65 +                                                                                                       
      66 +interface InvoiceResponse {                                                                            
      67 +  success: boolean                                                                                     
      68 +  updated: number                                                                                      
      69 +}                                                                                                      
      70 +                                                                                                       
      71 +interface FeeResponse {                                                                                
      72 +  success: boolean                                                                                     
      73 +  updated: number                                                                                      
      74 +}                                                                                                      
      75 +                                                                                                       
      76  export const adminApi = {
      77    // Registration Code Batch Endpoints
      78

⏺ Now add the new API methods:

⏺ Update(forecasto-client-web/src/api/admin.ts)
  ⎿  Added 51 lines
      156      const response = await
           apiClient.patch<BatchResponse>(`/admin/registration-codes/batches/${batchId}/assign-partner`, {
           partner_id: partnerId })
      157      return response.data.batch
      158    },
      159 +                                                                                                      
      160 +  setPartnerType: async (userId: string, partnerType: string): Promise<AdminUser> => {                
      161 +    const response = await apiClient.patch<UserResponse>(`/admin/users/${userId}/partner-type`, {     
          +partner_type: partnerType })                                                                          
      162 +    return response.data.user                                                                         
      163 +  },                                                                                                  
      164 +                                                                                                      
      165 +  // Report and Billing Endpoints                                                                     
      166 +                                                                                                      
      167 +  getActivatedCodesReport: async (filters?: ActivatedCodesReportFilter):                              
          +Promise<ActivatedCodeReportRow[]> => {                                                                
      168 +    const params = new URLSearchParams()                                                              
      169 +    if (filters?.partner_id) params.append('partner_id', filters.partner_id)                          
      170 +    if (filters?.month) params.append('month', filters.month.toString())                              
      171 +    if (filters?.year) params.append('year', filters.year.toString())                                 
      172 +    if (filters?.invoiced !== undefined) params.append('invoiced', filters.invoiced.toString())       
      173 +                                                                                                      
      174 +    const response = await                                                                            
          +apiClient.get<ActivatedCodesReportResponse>(`/admin/reports/activated-codes?${params}`)               
      175 +    return response.data.rows                                                                         
      176 +  },                                                                                                  
      177 +                                                                                                      
      178 +  invoiceCodes: async (data: InvoiceCodesRequest): Promise<number> => {                               
      179 +    const response = await apiClient.post<InvoiceResponse>('/admin/reports/activated-codes/invoice',  
          +data)                                                                                                 
      180 +    return response.data.updated                                                                      
      181 +  },                                                                                                  
      182 +                                                                                                      
      183 +  recognizePartnerFee: async (codeIds: string[]): Promise<number> => {                                
      184 +    const response = await                                                                            
          +apiClient.post<FeeResponse>('/admin/reports/activated-codes/recognize-fee', { code_ids: codeIds })    
      185 +    return response.data.updated                                                                      
      186 +  },                                                                                                  
      187 +                                                                                                      
      188 +  getBillingSummary: async (filters?: BillingSummaryFilter): Promise<PartnerBillingSummary[]> => {    
      189 +    const params = new URLSearchParams()                                                              
      190 +    if (filters?.partner_id) params.append('partner_id', filters.partner_id)                          
      191 +    if (filters?.month) params.append('month', filters.month.toString())                              
      192 +    if (filters?.year) params.append('year', filters.year.toString())                                 
      193 +                                                                                                      
      194 +    const response = await                                                                            
          +apiClient.get<BillingSummaryResponse>(`/admin/reports/billing-summary?${params}`)                     
      195 +    return response.data.summaries                                                                    
      196 +  },                                                                                                  
      197 +                                                                                                      
      198 +  exportActivatedCodesCSV: async (filters?: ActivatedCodesReportFilter): Promise<Blob> => {           
      199 +    const params = new URLSearchParams()                                                              
      200 +    if (filters?.partner_id) params.append('partner_id', filters.partner_id)                          
      201 +    if (filters?.month) params.append('month', filters.month.toString())                              
      202 +    if (filters?.year) params.append('year', filters.year.toString())                                 
      203 +    if (filters?.invoiced !== undefined) params.append('invoiced', filters.invoiced.toString())       
      204 +                                                                                                      
      205 +    const response = await apiClient.get(`/admin/reports/activated-codes/export?${params}`, {         
      206 +      responseType: 'blob',                                                                           
      207 +    })                                                                                                
      208 +    return response.data                                                                              
      209 +  },                                                                                                  
      210  }

⏺ Now update the partner API types:

⏺ Update(forecasto-client-web/src/api/partner.ts)
  ⎿  Added 2 lines
       9    used_by_name: string | null
      10    used_by_email: string | null
      11    revoked_at: string | null
      12 +  invoiced: boolean                                                                                    
      13 +  invoiced_to: string | null                                                                           
      14  }
      15
      16  export interface PartnerBatch {

⏺ Task 5: Frontend Admin UI pages and updates

  Let me start with the two new pages in parallel, plus the AdminLayout and routes updates.

  First, create the ActivatedCodesReportPage:

⏺ Write(forecasto-client-web/src/pages/admin/ActivatedCodesReportPage.tsx)
  ⎿  Wrote 456 lines to forecasto-client-web/src/pages/admin/ActivatedCodesReportPage.tsx
     import { useEffect, useState } from 'react'
     import { Card, CardContent } from '@/components/ui/card'
     import { Button } from '@/components/ui/button'
     import { Badge } from '@/components/ui/badge'
     import { Checkbox } from '@/components/ui/checkbox'
     import { Input } from '@/components/ui/input'
     import {
       Dialog,
       DialogContent,
       DialogDescription,
     … +446 lines (ctrl+o to expand)

⏺ Now create the BillingSummaryPage:

⏺ Write(forecasto-client-web/src/pages/admin/BillingSummaryPage.tsx)
  ⎿  Wrote 354 lines to forecasto-client-web/src/pages/admin/BillingSummaryPage.tsx
     import { useEffect, useState } from 'react'
     import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
     import { Button } from '@/components/ui/button'
     import { Badge } from '@/components/ui/badge'
     import { Input } from '@/components/ui/input'
     import {
       Select,
       SelectContent,
       SelectItem,
       SelectTrigger,
     … +344 lines (ctrl+o to expand)

⏺ Now update AdminLayout to add navigation items:

⏺ Update(forecasto-client-web/src/pages/admin/AdminLayout.tsx)
  ⎿  Added 1 line, removed 1 line
      1  import { Outlet, NavLink, Navigate } from 'react-router-dom'
      2  import { useAuthStore } from '@/stores/authStore'
      3 -import { Users, KeyRound, LayoutDashboard, ArrowLeft } from 'lucide-react'                              
      3 +import { Users, KeyRound, LayoutDashboard, ArrowLeft, FileBarChart, Receipt } from 'lucide-react'       
      4  import { cn } from '@/lib/utils'
      5
      6  const navItems = [

⏺ Update(forecasto-client-web/src/pages/admin/AdminLayout.tsx)
  ⎿  Added 2 lines
       7    { to: '/admin', icon: LayoutDashboard, label: 'Dashboard', end: true },
       8    { to: '/admin/codes', icon: KeyRound, label: 'Codici Invito', end: false },
       9    { to: '/admin/users', icon: Users, label: 'Utenti', end: false },
      10 +  { to: '/admin/reports/activations', icon: FileBarChart, label: 'Report Attivazioni', end: false },   
      11 +  { to: '/admin/reports/billing', icon: Receipt, label: 'Report Fatturazione', end: false },           
      12  ]
      13
      14  export function AdminLayout() {

⏺ Now update the admin pages index:

⏺ Update(forecasto-client-web/src/pages/admin/index.ts)
  ⎿  Added 2 lines
      2  export { AdminDashboard } from './AdminDashboard'
      3  export { RegistrationCodesPage } from './RegistrationCodesPage'
      4  export { UsersPage } from './UsersPage'
      5 +export { ActivatedCodesReportPage } from './ActivatedCodesReportPage'                                   
      6 +export { BillingSummaryPage } from './BillingSummaryPage'                                               

⏺ Now update routes:

⏺ Update(forecasto-client-web/src/routes/index.tsx)
  ⎿  Added 1 line, removed 1 line
       6  import { CashflowPage } from '@/pages/CashflowPage'
       7  import { SettingsPage } from '@/pages/SettingsPage'
       8  import { NotFoundPage } from '@/pages/NotFoundPage'
       9 -import { AdminLayout, AdminDashboard, RegistrationCodesPage, UsersPage } from '@/pages/admin'          
       9 +import { AdminLayout, AdminDashboard, RegistrationCodesPage, UsersPage,                                
         +ActivatedCodesReportPage, BillingSummaryPage } from '@/pages/admin'                                    
      10  import { useAuthStore } from '@/stores/authStore'
      11
      12  function ProtectedRoute({ children }: { children: React.ReactNode }) {

⏺ Update(forecasto-client-web/src/routes/index.tsx)
  ⎿  Added 2 lines
      71        { index: true, element: <AdminDashboard /> },
      72        { path: 'codes', element: <RegistrationCodesPage /> },
      73        { path: 'users', element: <UsersPage /> },
      74 +      { path: 'reports/activations', element: <ActivatedCodesReportPage /> },                          
      75 +      { path: 'reports/billing', element: <BillingSummaryPage /> },                                    
      76      ],
      77    },
      78    { path: '*', element: <NotFoundPage /> },

⏺ Now update UsersPage with partner type dialog and badge:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 10 lines, removed 1 line
      44    })
      45  }
      46
      47 +function partnerTypeLabel(type: string | null): string {                                               
      48 +  if (type === 'billing_to_client') return 'Fatt. Cliente'                                             
      49 +  if (type === 'billing_to_partner') return 'Fatt. Partner'                                            
      50 +  return ''                                                                                            
      51 +}                                                                                                      
      52 +                                                                                                       
      53  function getUserStatus(user: AdminUser): { label: string; variant: 'default' | 'secondary' |
          'destructive' | 'outline' }[] {
      54    const badges: { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline' }[] = []
      55    if (user.is_admin) badges.push({ label: 'Admin', variant: 'default' })
      56 -  if (user.is_partner) badges.push({ label: 'Partner', variant: 'outline' })                           
      56 +  if (user.is_partner) {                                                                               
      57 +    const ptLabel = partnerTypeLabel(user.partner_type)                                                
      58 +    badges.push({ label: ptLabel ? `Partner - ${ptLabel}` : 'Partner', variant: 'outline' })           
      59 +  }                                                                                                    
      60    if (user.is_blocked) badges.push({ label: 'Bloccato', variant: 'destructive' })
      61    if (badges.length === 0) badges.push({ label: 'Attivo', variant: 'secondary' })
      62    return badges

⏺ Now update the UsersPage to add partner type selection dialog. I need to add state for it and update
  handleTogglePartner:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 3 lines
      73      page_size: 50,
      74    })
      75    const [blockDialogOpen, setBlockDialogOpen] = useState(false)
      76 +  const [partnerDialogOpen, setPartnerDialogOpen] = useState(false)                                    
      77 +  const [partnerTypeDialogOpen, setPartnerTypeDialogOpen] = useState(false)                            
      78    const [selectedUser, setSelectedUser] = useState<AdminUser | null>(null)
      79    const [blockReason, setBlockReason] = useState('')
      80 +  const [selectedPartnerType, setSelectedPartnerType] = useState<string>('billing_to_partner')         
      81    const [processing, setProcessing] = useState(false)
      82
      83    const fetchUsers = async () => {

⏺ Now update handleTogglePartner to open dialog instead of directly toggling:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 56 lines, removed 4 lines
      152    }
      153
      154    const handleTogglePartner = async (user: AdminUser) => {
      155 +    if (user.is_partner) {                                                                            
      156 +      // Remove partner                                                                               
      157 +      setProcessing(true)                                                                             
      158 +      try {                                                                                           
      159 +        await adminApi.setPartner(user.id, false)                                                     
      160 +        toast({ title: 'Ruolo Partner rimosso' })                                                     
      161 +        fetchUsers()                                                                                  
      162 +      } catch (error) {                                                                               
      163 +        toast({                                                                                       
      164 +          title: 'Errore',                                                                            
      165 +          description: 'Impossibile aggiornare il ruolo partner',                                     
      166 +          variant: 'destructive',                                                                     
      167 +        })                                                                                            
      168 +      } finally {                                                                                     
      169 +        setProcessing(false)                                                                          
      170 +      }                                                                                               
      171 +    } else {                                                                                          
      172 +      // Promote to partner: open dialog to choose type                                               
      173 +      setSelectedUser(user)                                                                           
      174 +      setSelectedPartnerType('billing_to_partner')                                                    
      175 +      setPartnerDialogOpen(true)                                                                      
      176 +    }                                                                                                 
      177 +  }                                                                                                   
      178 +                                                                                                      
      179 +  const handlePromoteToPartner = async () => {                                                        
      180 +    if (!selectedUser) return                                                                         
      181      setProcessing(true)
      182      try {
      183 -      const newValue = !user.is_partner                                                               
      184 -      await adminApi.setPartner(user.id, newValue)                                                    
      185 -      toast({ title: newValue ? 'Utente promosso a Partner' : 'Ruolo Partner rimosso' })              
      183 +      await adminApi.setPartner(selectedUser.id, true)                                                
      184 +      await adminApi.setPartnerType(selectedUser.id, selectedPartnerType)                             
      185 +      toast({ title: 'Utente promosso a Partner' })                                                   
      186 +      setPartnerDialogOpen(false)                                                                     
      187        fetchUsers()
      188      } catch (error) {
      189        toast({
      190          title: 'Errore',
      191 -        description: 'Impossibile aggiornare il ruolo partner',                                       
      191 +        description: 'Impossibile promuovere a partner',                                              
      192          variant: 'destructive',
      193        })
      194      } finally {
     ...
      169      }
      170    }
      171
      172 +  const openPartnerTypeDialog = (user: AdminUser) => {                                                
      173 +    setSelectedUser(user)                                                                             
      174 +    setSelectedPartnerType(user.partner_type || 'billing_to_partner')                                 
      175 +    setPartnerTypeDialogOpen(true)                                                                    
      176 +  }                                                                                                   
      177 +                                                                                                      
      178 +  const handleChangePartnerType = async () => {                                                       
      179 +    if (!selectedUser) return                                                                         
      180 +    setProcessing(true)                                                                               
      181 +    try {                                                                                             
      182 +      await adminApi.setPartnerType(selectedUser.id, selectedPartnerType)                             
      183 +      toast({ title: 'Tipo partner aggiornato' })                                                     
      184 +      setPartnerTypeDialogOpen(false)                                                                 
      185 +      fetchUsers()                                                                                    
      186 +    } catch (error) {                                                                                 
      187 +      toast({                                                                                         
      188 +        title: 'Errore',                                                                              
      189 +        description: 'Impossibile aggiornare il tipo partner',                                        
      190 +        variant: 'destructive',                                                                       
      191 +      })                                                                                              
      192 +    } finally {                                                                                       
      193 +      setProcessing(false)                                                                            
      194 +    }                                                                                                 
      195 +  }                                                                                                   
      196 +                                                                                                      
      197    return (
      198      <div className="space-y-6">
      199        <div>

⏺ Now update the actions buttons in the table to add "Modifica tipo" for existing partners and import Settings icon:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 1 line, removed 1 line
      30  import { Label } from '@/components/ui/label'
      31  import { adminApi } from '@/api/admin'
      32  import type { AdminUser, UserFilter } from '@/types/admin'
      33 -import { Search, Ban, CheckCircle, Shield, Handshake } from 'lucide-react'                             
      33 +import { Search, Ban, CheckCircle, Shield, Handshake, Settings } from 'lucide-react'                   
      34  import { toast } from '@/hooks/useToast'
      35
      36  function formatDate(date: string | null): string {

⏺ Now add the "Modifica tipo" button next to the partner toggle button:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 12 lines
      332                                    <Handshake className="h-4 w-4 mr-1" />
      333                                    {user.is_partner ? 'Rimuovi Partner' : 'Partner'}
      334                                  </Button>
      335 +                                {user.is_partner && (                                                 
      336 +                                  <Button                                                             
      337 +                                    variant="ghost"                                                   
      338 +                                    size="sm"                                                         
      339 +                                    onClick={() => openPartnerTypeDialog(user)}                       
      340 +                                    disabled={processing}                                             
      341 +                                    title="Modifica tipo partner"                                     
      342 +                                  >                                                                   
      343 +                                    <Settings className="h-4 w-4 mr-1" />                             
      344 +                                    Tipo                                                              
      345 +                                  </Button>                                                           
      346 +                                )}                                                                    
      347                                  <Button
      348                                    variant="ghost"
      349                                    size="sm"

⏺ Now add the two new dialogs (partner promotion dialog and partner type dialog) at the bottom of the component, after
  the block dialog:

⏺ Update(forecasto-client-web/src/pages/admin/UsersPage.tsx)
  ⎿  Added 62 lines
      396            </DialogFooter>
      397          </DialogContent>
      398        </Dialog>
      399 +                                                                                                      
      400 +      <Dialog open={partnerDialogOpen} onOpenChange={setPartnerDialogOpen}>                           
      401 +        <DialogContent>                                                                               
      402 +          <DialogHeader>                                                                              
      403 +            <DialogTitle>Promuovi a Partner</DialogTitle>                                             
      404 +            <DialogDescription>                                                                       
      405 +              Scegli il tipo di fatturazione per il partner <strong>{selectedUser?.name}</strong>.    
      406 +            </DialogDescription>                                                                      
      407 +          </DialogHeader>                                                                             
      408 +          <div className="py-4 space-y-3">                                                            
      409 +            <Label>Tipo fatturazione</Label>                                                          
      410 +            <Select value={selectedPartnerType} onValueChange={setSelectedPartnerType}>               
      411 +              <SelectTrigger>                                                                         
      412 +                <SelectValue />                                                                       
      413 +              </SelectTrigger>                                                                        
      414 +              <SelectContent>                                                                         
      415 +                <SelectItem value="billing_to_client">Fatturazione a cliente</SelectItem>             
      416 +                <SelectItem value="billing_to_partner">Fatturazione a partner</SelectItem>            
      417 +              </SelectContent>                                                                        
      418 +            </Select>                                                                                 
      419 +          </div>                                                                                      
      420 +          <DialogFooter>                                                                              
      421 +            <Button variant="outline" onClick={() => setPartnerDialogOpen(false)}>                    
      422 +              Annulla                                                                                 
      423 +            </Button>                                                                                 
      424 +            <Button onClick={handlePromoteToPartner} disabled={processing}>                           
      425 +              {processing ? 'Promozione...' : 'Promuovi'}                                             
      426 +            </Button>                                                                                 
      427 +          </DialogFooter>                                                                             
      428 +        </DialogContent>                                                                              
      429 +      </Dialog>                                                                                       
      430 +                                                                                                      
      431 +      <Dialog open={partnerTypeDialogOpen} onOpenChange={setPartnerTypeDialogOpen}>                   
      432 +        <DialogContent>                                                                               
      433 +          <DialogHeader>                                                                              
      434 +            <DialogTitle>Modifica tipo partner</DialogTitle>                                          
      435 +            <DialogDescription>                                                                       
      436 +              Modifica il tipo di fatturazione per <strong>{selectedUser?.name}</strong>.             
      437 +            </DialogDescription>                                                                      
      438 +          </DialogHeader>                                                                             
      439 +          <div className="py-4 space-y-3">                                                            
      440 +            <Label>Tipo fatturazione</Label>                                                          
      441 +            <Select value={selectedPartnerType} onValueChange={setSelectedPartnerType}>               
      442 +              <SelectTrigger>                                                                         
      443 +                <SelectValue />                                                                       
      444 +              </SelectTrigger>                                                                        
      445 +              <SelectContent>                                                                         
      446 +                <SelectItem value="billing_to_client">Fatturazione a cliente</SelectItem>             
      447 +                <SelectItem value="billing_to_partner">Fatturazione a partner</SelectItem>            
      448 +              </SelectContent>                                                                        
      449 +            </Select>                                                                                 
      450 +          </div>                                                                                      
      451 +          <DialogFooter>                                                                              
      452 +            <Button variant="outline" onClick={() => setPartnerTypeDialogOpen(false)}>                
      453 +              Annulla                                                                                 
      454 +            </Button>                                                                                 
      455 +            <Button onClick={handleChangePartnerType} disabled={processing}>                          
      456 +              {processing ? 'Aggiornamento...' : 'Aggiorna'}                                          
      457 +            </Button>                                                                                 
      458 +          </DialogFooter>                                                                             
      459 +        </DialogContent>                                                                              
      460 +      </Dialog>                                                                                       
      461      </div>
      462    )
      463  }

⏺ Now update RegistrationCodesPage to add billing columns in the batch detail table:

⏺ Update(forecasto-client-web/src/pages/admin/RegistrationCodesPage.tsx)
  ⎿  Added 22 lines
      228                      <TableHead>Stato</TableHead>
      229                      <TableHead>Usato da</TableHead>
      230                      <TableHead>Data uso</TableHead>
      231 +                    <TableHead>Fatturato</TableHead>                                                  
      232 +                    <TableHead>Fatt. a</TableHead>                                                    
      233 +                    <TableHead>Fee</TableHead>                                                        
      234                      <TableHead className="w-[100px]">Azioni</TableHead>
      235                    </TableRow>
      236                  </TableHeader>
     ...
      243                          <TableCell>{code.used_by_email || '-'}</TableCell>
      244                          <TableCell>{formatDate(code.used_at)}</TableCell>
      245                          <TableCell>
      246 +                          {code.invoiced ? (                                                          
      247 +                            <Badge variant="default">Si</Badge>                                       
      248 +                          ) : (                                                                       
      249 +                            <Badge variant="outline">No</Badge>                                       
      250 +                          )}                                                                          
      251 +                        </TableCell>                                                                  
      252 +                        <TableCell>{code.invoiced_to || '-'}</TableCell>                              
      253 +                        <TableCell>                                                                   
      254 +                          {code.invoiced && code.invoiced_to === 'client' ? (                         
      255 +                            code.partner_fee_recognized ? (                                           
      256 +                              <Badge variant="default">Si</Badge>                                     
      257 +                            ) : (                                                                     
      258 +                              <Badge variant="outline">Pendente</Badge>                               
      259 +                            )                                                                         
      260 +                          ) : (                                                                       
      261 +                            '-'                                                                       
      262 +                          )}                                                                          
      263 +                        </TableCell>                                                                  
      264 +                        <TableCell>                                                                   
      265                            <div className="flex items-center gap-1">
      266                              <Button
      267                                variant="ghost"

⏺ Task 6: Update PartnershipTab

⏺ Update(forecasto-client-web/src/components/settings/PartnershipTab.tsx)
  ⎿  Added 10 lines
      111                    <TableHead>Stato</TableHead>
      112                    <TableHead>Usato da</TableHead>
      113                    <TableHead>Data uso</TableHead>
      114 +                  <TableHead>Fatturato</TableHead>                                                    
      115 +                  <TableHead>Fatt. a</TableHead>                                                      
      116                  </TableRow>
      117                </TableHeader>
      118                <TableBody>
     ...
      124                        </TableCell>
      125                        <TableCell>{code.used_by_name || '-'}</TableCell>
      126                        <TableCell>{formatDate(code.used_at)}</TableCell>
      127 +                      <TableCell>                                                                     
      128 +                        {code.invoiced ? (                                                            
      129 +                          <Badge variant="default">Si</Badge>                                         
      130 +                        ) : (                                                                         
      131 +                          <Badge variant="outline">No</Badge>                                         
      132 +                        )}                                                                            
      133 +                      </TableCell>                                                                    
      134 +                      <TableCell>{code.invoiced_to || '-'}</TableCell>                                
      135                      </TableRow>
      136                    )
      137                  })}

⏺ Now add billing stats in PartnershipTab:

⏺ Update(forecasto-client-web/src/components/settings/PartnershipTab.tsx)
  ⎿  Added 18 lines, removed 1 line
      171    const totalCodes = batches.reduce((sum, b) => sum + b.total_codes, 0)
      172    const usedCodes = batches.reduce((sum, b) => sum + b.used_codes, 0)
      173    const availableCodes = batches.reduce((sum, b) => sum + b.available_codes, 0)
      174 +  const invoicedCodes = batches.reduce(                                                               
      175 +    (sum, b) => sum + b.codes.filter((c) => c.invoiced).length,                                       
      176 +    0                                                                                                 
      177 +  )                                                                                                   
      178 +  const notInvoicedUsed = usedCodes - invoicedCodes                                                   
      179
      180    return (
      181      <div className="space-y-6">
      182 -      <div className="grid grid-cols-3 gap-4">                                                        
      182 +      <div className="grid grid-cols-5 gap-4">                                                        
      183          <Card>
      184            <CardContent className="pt-6">
      185              <div className="text-2xl font-bold">{totalCodes}</div>
     ...
      193              <p className="text-xs text-muted-foreground">Disponibili</p>
      194            </CardContent>
      195          </Card>
      196 +        <Card>                                                                                        
      197 +          <CardContent className="pt-6">                                                              
      198 +            <div className="text-2xl font-bold">{invoicedCodes}</div>                                 
      199 +            <p className="text-xs text-muted-foreground">Fatturati</p>                                
      200 +          </CardContent>                                                                              
      201 +        </Card>                                                                                       
      202 +        <Card>                                                                                        
      203 +          <CardContent className="pt-6">                                                              
      204 +            <div className="text-2xl font-bold">{notInvoicedUsed}</div>                               
      205 +            <p className="text-xs text-muted-foreground">Usati non fatt.</p>                          
      206 +          </CardContent>                                                                              
      207 +        </Card>                                                                                       
      208        </div>
      209
      210        <Card>

⏺ Now let me check if there's a Checkbox component available, and verify the TypeScript build:

⏺ Searched for 1 pattern (ctrl+o to expand)

⏺ Good, Checkbox exists. Let me now run the TypeScript check:

⏺ Bash(cd /Users/cashbit/dev/forecasto/forecasto-client-web && npx tsc --noEmit 2>&1 | head -60)
  ⎿  (No content)

⏺ Zero TypeScript errors. Now let me also verify the build:

⏺ Bash(npx vite build 2>&1 | tail -20)
  ⎿  vite v7.3.1 building client environment for production...
     transforming...
     ✓ 3558 modules transformed.
     … +14 lines (ctrl+o to expand)
  ⎿  (timeout 1m)

⏺ Build successful. Let me also do a quick check of the Python backend syntax:

⏺ Bash(cd /Users/cashbit/dev/forecasto/forecasto-server && python -c "from forecasto.models.user import User; from
      forecasto.models.registration_code import Registrati…)
  ⎿  Error: Exit code 127
     (eval):1: command not found: python

⏺ Bash(cd /Users/cashbit/dev/forecasto/forecasto-server && python3 -c "from forecasto.models.user import User; from
      forecasto.models.registration_code import Registrat…)
  ⎿  All imports OK

⏺ Bash(python3 -c "from forecasto.services.admin_service import AdminService; from forecasto.api.admin import router;
      print('Service and API imports OK')" 2>&1)
  ⎿  Service and API imports OK

⏺ Everything passes. Let me do a final check of all tasks:

⏺ All tasks completed. Here's a summary of everything implemented:

  Summary

  Backend Changes

  Models:
  - user.py - Added partner_type field (String(20), nullable)
  - registration_code.py - Added 6 billing fields: invoiced, invoiced_at, invoiced_to, invoice_note,
  partner_fee_recognized, partner_fee_recognized_at

  Migration:
  - Created 011_add_billing_system.py - Recreates both tables with new fields using SQLite pattern

  Schemas (admin.py):
  - Updated AdminUserResponse with partner_type
  - Updated RegistrationCodeResponse with 6 billing fields
  - Added: SetPartnerTypeRequest, InvoiceCodesRequest, RecognizeFeeRequest, ActivatedCodesReportFilter,
  ActivatedCodeReportRow, PartnerBillingSummary

  Schemas (partner.py):
  - Updated PartnerCodeResponse with invoiced, invoiced_to

  Service (admin_service.py):
  - Updated list_users/get_user to include partner_type
  - Updated set_partner to set default partner_type
  - Updated get_batch/list_codes/get_code to include billing fields
  - Updated partner batch methods with billing fields
  - Added: set_partner_type, get_activated_codes_report, invoice_codes, recognize_partner_fee, get_billing_summary,
  export_activated_codes_csv

  API (admin.py):
  - PATCH /admin/users/{id}/partner-type
  - GET /admin/reports/activated-codes
  - POST /admin/reports/activated-codes/invoice
  - POST /admin/reports/activated-codes/recognize-fee
  - GET /admin/reports/billing-summary
  - GET /admin/reports/activated-codes/export (CSV download)

  Frontend Changes

  Types/API:
  - Updated AdminUser with partner_type
  - Updated RegistrationCode with 6 billing fields
  - Updated PartnerCode with invoiced, invoiced_to
  - Added report/billing types and API methods

  New Pages:
  - ActivatedCodesReportPage - Full report with filters, checkboxes, bulk invoice/fee actions, CSV export, summary cards
  - BillingSummaryPage - Per-partner billing summary with expandable detail rows

  Updated Pages:
  - AdminLayout - Added "Report Attivazioni" and "Report Fatturazione" nav items
  - UsersPage - Partner type in badge, promote dialog with type choice, change type action
  - RegistrationCodesPage - Added Fatturato/Fatt. a/Fee columns in batch detail
  - PartnershipTab - Added Fatturato/Fatt. a columns, billing stats cards
  - Routes and exports updated

  Verification: npx tsc --noEmit and npx vite build both pass with zero errors.

✻ Cooked for 9m 19s

❯ [Error] Failed to load resource: the server responded with a status of 404 (Not Found) (activated-codes, line 0)  
  [Error] Failed to load resource: the server responded with a status of 404 (Not Found) (activated-codes, line 0)  
  [Error] Failed to load resource: the server responded with a status of 404 (Not Found) (billing-summary, line 0)  
  [Error] Failed to load resource: the server responded with a status of 404 (Not Found) (activated-codes, line 0)  

⏺ The 404 errors indicate the new API endpoints aren't being registered. Let me check how the admin router is included
  in the main app.

⏺ Read 2 files (ctrl+o to expand)

⏺ The router registration looks correct — admin.router is mounted at /api/v1/admin. The issue is likely that the server
  needs to be restarted to pick up the new endpoints, or the migration hasn't been run. Let me check if the migration
  has been applied and if the server is running.

⏺ Bash(python3 -m alembic upgrade head 2>&1)
  ⎿ INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
    INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
    INFO  [alembic.runtime.migration] Running upgrade 010_add_partner_system -> 011_add_billing_system, Add billing
     system: partner_type on users, billing fields on registration_codes


⏺ Migration applied. Now let me check what's running the server and restart it:

⏺ Bash(lsof -i :8000 -t 2>/dev/null)
  ⎿  95882

⏺ Bash(ps -p 95882 -o command= 2>/dev/null)
  ⎿ /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/Resources/Python.app/Cont
    ents/MacOS/Python -m uvicorn forecasto.main:app --host 0.0.0.0 --port 8000


⏺ The server is running but without --reload, so it hasn't picked up the new code. Let me quickly verify the endpoint
  actually exists in the router definition before restarting:

⏺ Bash(python3 -c "
      from forecasto.api.admin import router…)
  ⎿  {'POST'} /registration-codes
     {'GET'} /registration-codes/batches
     {'GET'} /registration-codes/batches/{batch_id}
     … +16 lines (ctrl+o to expand)

⏺ All routes are registered correctly. The server just needs a restart. There's a route ordering issue though — GET
  /reports/activated-codes/export might conflict with GET /reports/activated-codes since FastAPI matches routes in
  order. Let me check the actual order in the file to make sure the more specific route (export) comes before the
  general one... Actually looking at the routes list, FastAPI handles this fine since /reports/activated-codes/export is
   a distinct path from /reports/activated-codes.

  The server needs to be restarted to pick up all the changes:

⏺ Bash(kill 95882 && sleep 1 && python3 -m uvicorn forecasto.main:app --host 0.0.0.0 --port 8000 &
      sleep 2…)
  ⎿  INFO:     127.0.0.1:64961 - "GET /health HTTP/1.1" 200 OK
     {
       "status": "healthy"
     … +5 lines (ctrl+o to expand)
  ⎿  (timeout 15s)

⏺ Server is back up. The 404s should be resolved now — the new endpoints are registered and the migration has been
  applied. Refresh the report pages in the browser and they should work.

✻ Crunched for 39s

⏺ Background command "Start the FastAPI server" failed with exit code 143

⏺ That's expected — exit code 143 is SIGTERM, which happened when I killed the old server to restart it. Let me verify
  the new server is running fine:

⏺ Bash(curl -s http://localhost:8000/health)
  ⎿  {
       "status": "healthy"
     }

⏺ Server is running. The old background task was just the previous server instance that got killed during the restart.
  The new endpoints should be accessible now — try refreshing the report pages in the browser.

❯ ho fatturazioni eseguite ma non le vedo nella lista fatturazioni 
  ⎿  [Image #1]
  ⎿  [Image #2]

⏺ The issue is clear — the Report Fatturazione page shows "Nessun dato" because the billing summary only includes codes
  that have a partner_id on their batch. Your test code (E4G8-5BW7-PNVZ) has Partner = "-", meaning the batch isn't
  assigned to any partner, so it's excluded from the billing summary.

  The billing summary is designed to group by partner, so codes without a partner won't appear there. But let me also
  check if there could be cases where you have codes assigned to a partner that are still not showing. Let me verify
  with a quick API call:

⏺ Bash(curl -s http://localhost:8000/api/v1/admin/reports/billing-summary?month=2\&year=2026 -H "Authorization: Bearer
      $(curl -s http://localhost:8000/api/v1/auth/logi…)
  ⎿  Auth failed, checking DB directly...
     === Activated codes with batch info ===
     ('E4G8-5BW7-PNVZ', '2026-02-05 15:19:07.107671', 1, 'client', 'Test Batch', None)
     … +6 lines (ctrl+o to expand)

⏺ Confirmed — the activated code belongs to "Test Batch" which has partner_id = None. The billing summary only shows
  partner-grouped data, which is correct by design. But codes without a partner should still be visible somewhere in the
   billing report.

  The issue is that the billing summary is only for partner codes. This is correct — it's a partner billing report.
  However, the Report Attivazioni page shows the code correctly (as seen in your first screenshot).

  But looking again at your message — you said "ho fatturazioni eseguite ma non le vedo nella lista fatturazioni". The
  Report Fatturazione should also show codes that ARE assigned to partners even if they're invoiced. The problem is your
   only invoiced code has no partner. Let me also make the billing summary page more useful by including a row for codes
   without a partner:

⏺ Read 1 file (ctrl+o to expand)

⏺ Now let me read the get_billing_summary method:

⏺ Read 1 file (ctrl+o to expand)

⏺ I see the issue. The get_billing_summary method on line 868 has RegistrationCodeBatch.partner_id.isnot(None) — it only
   considers codes from batches that have a partner assigned. Your invoiced code is on a batch without a partner, so
  it's excluded.

  I need to include a "Senza partner" row for codes from batches without a partner. Let me update the method:

⏺ Update(~/dev/forecasto/forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 82 lines, removed 77 lines
      856      async def get_billing_summary(
      857          self, partner_id: str | None, month: int | None, year: int | None
      858      ) -> list[PartnerBillingSummary]:
      859 -        """Get billing summary grouped by partner."""                                                 
      860 -        # Get all partner batches with activated codes                                                
      861 -        query = (                                                                                     
      862 -            select(                                                                                   
      863 -                RegistrationCodeBatch.partner_id,                                                     
      864 -            )                                                                                         
      865 -            .join(RegistrationCode, RegistrationCode.batch_id == RegistrationCodeBatch.id)            
      866 -            .where(                                                                                   
      867 -                RegistrationCode.used_at.isnot(None),                                                 
      868 -                RegistrationCodeBatch.partner_id.isnot(None),                                         
      869 -            )                                                                                         
      870 -        )                                                                                             
      859 +        """Get billing summary grouped by partner (includes codes without partner)."""                
      860
      861 -        if partner_id:                                                                                
      862 -            query = query.where(RegistrationCodeBatch.partner_id == partner_id)                       
      863 -                                                                                                      
      864 -        if month and year:                                                                            
      865 -            from calendar import monthrange                                                           
      866 -                                                                                                      
      867 -            start = datetime(year, month, 1)                                                          
      868 -            _, last_day = monthrange(year, month)                                                     
      869 -            end = datetime(year, month, last_day, 23, 59, 59)                                         
      870 -            query = query.where(                                                                      
      871 -                RegistrationCode.used_at >= start,                                                    
      872 -                RegistrationCode.used_at <= end,                                                      
      873 -            )                                                                                         
      874 -        elif year:                                                                                    
      875 -            start = datetime(year, 1, 1)                                                              
      876 -            end = datetime(year, 12, 31, 23, 59, 59)                                                  
      877 -            query = query.where(                                                                      
      878 -                RegistrationCode.used_at >= start,                                                    
      879 -                RegistrationCode.used_at <= end,                                                      
      880 -            )                                                                                         
      881 -                                                                                                      
      882 -        query = query.group_by(RegistrationCodeBatch.partner_id)                                      
      883 -        result = await self.db.execute(query)                                                         
      884 -        partner_ids_rows = result.all()                                                               
      885 -                                                                                                      
      886 -        summaries = []                                                                                
      887 -        for row in partner_ids_rows:                                                                  
      888 -            pid = row[0]                                                                              
      889 -                                                                                                      
      890 -            # Get partner info                                                                        
      891 -            partner_result = await self.db.execute(                                                   
      892 -                select(User).where(User.id == pid)                                                    
      893 -            )                                                                                         
      894 -            partner = partner_result.scalar_one_or_none()                                             
      895 -            if not partner:                                                                           
      896 -                continue                                                                              
      897 -                                                                                                      
      898 -            # Build stats query for this partner                                                      
      899 -            codes_query = (                                                                           
      900 -                select(RegistrationCode)                                                              
      901 -                .join(RegistrationCodeBatch, RegistrationCode.batch_id == RegistrationCodeBatch.id)   
      902 -                .where(                                                                               
      903 -                    RegistrationCode.used_at.isnot(None),                                             
      904 -                    RegistrationCodeBatch.partner_id == pid,                                          
      905 -                )                                                                                     
      906 -            )                                                                                         
      907 -                                                                                                      
      861 +        def _apply_date_filter(q, month, year):                                                       
      862              if month and year:
      863                  from calendar import monthrange
      864
      865                  start = datetime(year, month, 1)
      866                  _, last_day = monthrange(year, month)
      867                  end = datetime(year, month, last_day, 23, 59, 59)
      868 -                codes_query = codes_query.where(                                                      
      868 +                q = q.where(                                                                          
      869                      RegistrationCode.used_at >= start,
      870                      RegistrationCode.used_at <= end,
      871                  )
      872              elif year:
      873                  start = datetime(year, 1, 1)
      874                  end = datetime(year, 12, 31, 23, 59, 59)
      875 -                codes_query = codes_query.where(                                                      
      875 +                q = q.where(                                                                          
      876                      RegistrationCode.used_at >= start,
      877                      RegistrationCode.used_at <= end,
      878                  )
      879 +            return q                                                                                  
      880
      881 -            codes_result = await self.db.execute(codes_query)                                         
      882 -            codes = codes_result.scalars().all()                                                      
      883 -                                                                                                      
      881 +        def _compute_stats(codes):                                                                    
      882              total = len(codes)
      883              invoiced_count = sum(1 for c in codes if c.invoiced)
      884              not_invoiced = total - invoiced_count
     ...
       947                  1 for c in codes
       948                  if c.invoiced and c.invoiced_to == "client" and not c.partner_fee_recognized
       949              )
       950 +            return total, invoiced_count, not_invoiced, to_client, to_partner, fee_recognized,       
           +fee_pending                                                                                          
       951
       952 -            summaries.append(                                                                        
       953 -                PartnerBillingSummary(                                                               
       954 -                    partner_id=pid,                                                                  
       955 -                    partner_name=partner.name,                                                       
       956 -                    partner_type=partner.partner_type,                                               
       957 -                    total_activated=total,                                                           
       958 -                    invoiced_count=invoiced_count,                                                   
       959 -                    not_invoiced_count=not_invoiced,                                                 
       960 -                    invoiced_to_client=to_client,                                                    
       961 -                    invoiced_to_partner=to_partner,                                                  
       962 -                    fee_recognized_count=fee_recognized,                                             
       963 -                    fee_pending_count=fee_pending,                                                   
       964 -                )                                                                                    
       952 +        # Get distinct partner_ids (including NULL) with activated codes                             
       953 +        query = (                                                                                    
       954 +            select(RegistrationCodeBatch.partner_id)                                                 
       955 +            .join(RegistrationCode, RegistrationCode.batch_id == RegistrationCodeBatch.id)           
       956 +            .where(RegistrationCode.used_at.isnot(None))                                             
       957 +        )                                                                                            
       958 +                                                                                                     
       959 +        if partner_id:                                                                               
       960 +            query = query.where(RegistrationCodeBatch.partner_id == partner_id)                      
       961 +                                                                                                     
       962 +        query = _apply_date_filter(query, month, year)                                               
       963 +        query = query.group_by(RegistrationCodeBatch.partner_id)                                     
       964 +        result = await self.db.execute(query)                                                        
       965 +        partner_ids_rows = result.all()                                                              
       966 +                                                                                                     
       967 +        summaries = []                                                                               
       968 +        for row in partner_ids_rows:                                                                 
       969 +            pid = row[0]                                                                             
       970 +                                                                                                     
       971 +            # Build stats query                                                                      
       972 +            codes_query = (                                                                          
       973 +                select(RegistrationCode)                                                             
       974 +                .join(RegistrationCodeBatch, RegistrationCode.batch_id == RegistrationCodeBatch.id)  
       975 +                .where(RegistrationCode.used_at.isnot(None))                                         
       976              )
       977
       978 +            if pid is None:                                                                          
       979 +                codes_query = codes_query.where(RegistrationCodeBatch.partner_id.is_(None))          
       980 +            else:                                                                                    
       981 +                codes_query = codes_query.where(RegistrationCodeBatch.partner_id == pid)             
       982 +                                                                                                     
       983 +            codes_query = _apply_date_filter(codes_query, month, year)                               
       984 +            codes_result = await self.db.execute(codes_query)                                        
       985 +            codes = codes_result.scalars().all()                                                     
       986 +                                                                                                     
       987 +            total, invoiced_count, not_invoiced, to_client, to_partner, fee_recognized, fee_pending  
           += _compute_stats(codes)                                                                              
       988 +                                                                                                     
       989 +            if pid is None:                                                                          
       990 +                # Codes without partner                                                              
       991 +                summaries.append(                                                                    
       992 +                    PartnerBillingSummary(                                                           
       993 +                        partner_id="__no_partner__",                                                 
       994 +                        partner_name="Senza partner",                                                
       995 +                        partner_type=None,                                                           
       996 +                        total_activated=total,                                                       
       997 +                        invoiced_count=invoiced_count,                                               
       998 +                        not_invoiced_count=not_invoiced,                                             
       999 +                        invoiced_to_client=to_client,                                                
      1000 +                        invoiced_to_partner=to_partner,                                              
      1001 +                        fee_recognized_count=fee_recognized,                                         
      1002 +                        fee_pending_count=fee_pending,                                               
      1003 +                    )                                                                                
      1004 +                )                                                                                    
      1005 +            else:                                                                                    
      1006 +                # Get partner info                                                                   
      1007 +                partner_result = await self.db.execute(                                              
      1008 +                    select(User).where(User.id == pid)                                               
      1009 +                )                                                                                    
      1010 +                partner_user = partner_result.scalar_one_or_none()                                   
      1011 +                if not partner_user:                                                                 
      1012 +                    continue                                                                         
      1013 +                                                                                                     
      1014 +                summaries.append(                                                                    
      1015 +                    PartnerBillingSummary(                                                           
      1016 +                        partner_id=pid,                                                              
      1017 +                        partner_name=partner_user.name,                                              
      1018 +                        partner_type=partner_user.partner_type,                                      
      1019 +                        total_activated=total,                                                       
      1020 +                        invoiced_count=invoiced_count,                                               
      1021 +                        not_invoiced_count=not_invoiced,                                             
      1022 +                        invoiced_to_client=to_client,                                                
      1023 +                        invoiced_to_partner=to_partner,                                              
      1024 +                        fee_recognized_count=fee_recognized,                                         
      1025 +                        fee_pending_count=fee_pending,                                               
      1026 +                    )                                                                                
      1027 +                )                                                                                    
      1028 +                                                                                                     
      1029          return summaries
      1030
      1031      async def export_activated_codes_csv(

⏺ Now update the BillingSummaryPage frontend to handle the __no_partner__ special ID for the detail expansion (it should
   pass partner_id=undefined for those):

⏺ Read 1 file (ctrl+o to expand)

⏺ The issue is that for "Senza partner" rows, it would pass partner_id: "__no_partner__" to the API, which would find
  nothing. I need to handle this: when expanding the "no partner" row, we should query codes without partner filtering
  but the backend report already returns all codes — the problem is the partner_id filter. Let me handle this
  differently: when the partner_id is __no_partner__, don't pass partner_id but instead we need a way to filter "codes
  without partner". Let me add support for that in the backend and frontend.

⏺ Read 1 file (ctrl+o to expand)

⏺ I'll add a special __no_partner__ filter support in the backend:

⏺ Update(~/dev/forecasto/forecasto-server/src/forecasto/services/admin_service.py)
  ⎿  Added 3 lines, removed 1 line
      727              .where(RegistrationCode.used_at.isnot(None))
      728          )
      729
      730 -        if filters.partner_id:                                                                        
      730 +        if filters.partner_id == "__no_partner__":                                                    
      731 +            query = query.where(RegistrationCodeBatch.partner_id.is_(None))                           
      732 +        elif filters.partner_id:                                                                      
      733              query = query.where(RegistrationCodeBatch.partner_id == filters.partner_id)
      734
      735          if filters.month and filters.year:

⏺ Now restart the server:

⏺ Bash(kill $(lsof -i :8000 -t) 2>/dev/null; sleep 1; python3 -m uvicorn forecasto.main:app --host 0.0.0.0 --port 8000 &
      sleep 2; curl -s http://localhost:8000/health)
  ⎿  INFO:     127.0.0.1:65256 - "GET /health HTTP/1.1" 200 OK
     {
       "status": "healthy"
     … +5 lines (ctrl+o to expand)
  ⎿  (timeout 15s)

⏺ Server restarted. Now the billing summary will show a "Senza partner" row for codes from batches without a partner
  assigned, and clicking to expand it will correctly load the details. Refresh the Report Fatturazione page.

✻ Cogitated for 1m 30s

❯ In HTML, <div> cannot be a child of <tbody>.                                                                      
  This will cause a hydration error.                                                                                
                                                                                                                    
    ...                                                                                                             
      <main className="flex-1 min...">                                                                              
        <Outlet>                                                                                                    
          <RenderedRoute match={{params:{}, ...}} routeContext={{outlet:null, ...}}>                                
            <BillingSummaryPage>                                                                                    
              <div className="space-y-6">                                                                           
                <div>                                                                                               
                <div>                                                                                               
                <_c>                                                                                                
                  <div ref={null} className="rounded-lg...">                                                        
                    <_c3>                                                                                           
                    <_c9 className="p-0">                                                                           
                      <div ref={null} className="p-0">                                                              
                        <_c>                                                                                        
                          <div className="relative w...">                                                           
                            <table ref={null} className="w-full cap...">                                            
                              <_c3>                                                                                 
                              <_c5>                                                                                 
  >                             <tbody ref={null} className={"[&_tr:last-child]:border-0"}>                         
                                  ...                                                                               
                                    <CollapsibleProvider scope={undefined} disabled={undefined}                     
  contentId="radix-_r_7j_" ...>                                                                                     
                                      <Primitive.div data-state="closed" data-disabled={undefined} ref={null}>      
  >                                     <div data-state="closed" data-disabled={undefined} ref={null}>              
                                                                                                                    

⏺ The issue is that CollapsibleContent renders a <div> inside <tbody>, which is invalid HTML. I need to restructure the
  PartnerSummaryRow component to avoid using Radix Collapsible inside a table, and instead use manual state-based
  show/hide.

⏺ Read 1 file (ctrl+o to expand)

⏺ I'll replace the Collapsible-based approach with plain state toggle using valid table elements only:

⏺ Update(src/pages/admin/BillingSummaryPage.tsx)
  ⎿  Removed 5 lines
      11    SelectValue,
      12  } from '@/components/ui/select'
      13  import {
      14 -  Collapsible,                                                                                         
      15 -  CollapsibleContent,                                                                                  
      16 -  CollapsibleTrigger,                                                                                  
      17 -} from '@/components/ui/collapsible'                                                                   
      18 -import {                                                                                               
      14    Table,
      15    TableBody,
      16    TableCell,

⏺ Now replace the entire PartnerSummaryRow component:

⏺ Update(src/pages/admin/BillingSummaryPage.tsx)
  ⎿  Added 32 lines, removed 34 lines
       87    }
       88
       89    return (
       90 -    <Collapsible open={isOpen} onOpenChange={handleToggle}>                                           
       91 -      <CollapsibleTrigger asChild>                                                                    
       92 -        <TableRow className="cursor-pointer hover:bg-muted/50">                                       
       93 -          <TableCell>                                                                                 
       94 -            <div className="flex items-center gap-2">                                                 
       95 -              {isOpen ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}   
       96 -              <span className="font-medium">{summary.partner_name}</span>                             
       97 -            </div>                                                                                    
       98 -          </TableCell>                                                                                
       99 -          <TableCell>                                                                                 
      100 -            <Badge variant="outline">{partnerTypeLabel(summary.partner_type)}</Badge>                 
      101 -          </TableCell>                                                                                
      102 -          <TableCell className="text-center">{summary.total_activated}</TableCell>                    
      103 -          <TableCell className="text-center">{summary.invoiced_count}</TableCell>                     
      104 -          <TableCell className="text-center">{summary.not_invoiced_count}</TableCell>                 
      105 -          <TableCell className="text-center">{summary.invoiced_to_client}</TableCell>                 
      106 -          <TableCell className="text-center">{summary.invoiced_to_partner}</TableCell>                
      107 -          <TableCell className="text-center">{summary.fee_recognized_count}</TableCell>               
      108 -          <TableCell className="text-center">                                                         
      109 -            {summary.fee_pending_count > 0 ? (                                                        
      110 -              <Badge variant="outline">{summary.fee_pending_count}</Badge>                            
      111 -            ) : (                                                                                     
      112 -              '0'                                                                                     
      113 -            )}                                                                                        
      114 -          </TableCell>                                                                                
      115 -        </TableRow>                                                                                   
      116 -      </CollapsibleTrigger>                                                                           
      117 -      <CollapsibleContent asChild>                                                                    
      118 -        <tr>                                                                                          
      119 -          <td colSpan={9} className="p-0">                                                            
       90 +    <>                                                                                                
       91 +      <TableRow className="cursor-pointer hover:bg-muted/50" onClick={handleToggle}>                  
       92 +        <TableCell>                                                                                   
       93 +          <div className="flex items-center gap-2">                                                   
       94 +            {isOpen ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}     
       95 +            <span className="font-medium">{summary.partner_name}</span>                               
       96 +          </div>                                                                                      
       97 +        </TableCell>                                                                                  
       98 +        <TableCell>                                                                                   
       99 +          <Badge variant="outline">{partnerTypeLabel(summary.partner_type)}</Badge>                   
      100 +        </TableCell>                                                                                  
      101 +        <TableCell className="text-center">{summary.total_activated}</TableCell>                      
      102 +        <TableCell className="text-center">{summary.invoiced_count}</TableCell>                       
      103 +        <TableCell className="text-center">{summary.not_invoiced_count}</TableCell>                   
      104 +        <TableCell className="text-center">{summary.invoiced_to_client}</TableCell>                   
      105 +        <TableCell className="text-center">{summary.invoiced_to_partner}</TableCell>                  
      106 +        <TableCell className="text-center">{summary.fee_recognized_count}</TableCell>                 
      107 +        <TableCell className="text-center">                                                           
      108 +          {summary.fee_pending_count > 0 ? (                                                          
      109 +            <Badge variant="outline">{summary.fee_pending_count}</Badge>                              
      110 +          ) : (                                                                                       
      111 +            '0'                                                                                       
      112 +          )}                                                                                          
      113 +        </TableCell>                                                                                  
      114 +      </TableRow>                                                                                     
      115 +      {isOpen && (                                                                                    
      116 +        <TableRow>                                                                                    
      117 +          <TableCell colSpan={9} className="p-0">                                                     
      118              <div className="bg-muted/30 p-4">
      119                {loading ? (
      120                  <div className="text-center py-4 text-muted-foreground">Caricamento...</div>
     ...
      174                  </Table>
      175                )}
      176              </div>
      177 -          </td>                                                                                       
      178 -        </tr>                                                                                         
      179 -      </CollapsibleContent>                                                                           
      180 -    </Collapsible>                                                                                    
      177 +          </TableCell>                                                                                
      178 +        </TableRow>                                                                                   
      179 +      )}                                                                                              
      180 +    </>                                                                                               
      181    )
      182  }
      183

⏺ Now verify the build still passes:

⏺ Bash(cd /Users/cashbit/dev/forecasto/forecasto-client-web && npx tsc --noEmit 2>&1)
  ⎿  (No content)

⏺ Clean build. The fix:

  1. HTML structure - Replaced Collapsible/CollapsibleContent (which renders <div> inside <tbody>) with a simple <>
  fragment + conditional {isOpen && <TableRow>...</TableRow>}. This keeps everything as valid <tr>/<td> elements inside
  <tbody>.
  2. Billing summary now includes codes without partner - The "Senza partner" row will appear for activated codes from
  batches not assigned to any partner, so your invoiced code will show up in Report Fatturazione.

  Refresh the page to see both fixes.

✻ Crunched for 47s

❯ /exit                                                                                                                 
  ⎿  See ya!
                                                                                                                        
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
❯                                                                                                                       
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
  ⏵⏵ accept edits on (shift+tab to cycle) · 33 files +1310 -32 · ctrl+t to hide tasks

Resume this session with:
claude --resume 8ddfb5bb-1f38-4159-bfe9-b00ed3498dd7

Total cost:            $19.92
Total duration (API):  37m 38s
Total duration (wall): 3h 30m 33s
Total code changes:    3479 lines added, 300 lines removed
Usage by model:
    claude-haiku-4-5:  102.7k input, 32.1k output, 2.0m cache read, 241.2k cache write ($0.77)
     claude-opus-4-6:  1.3k input, 110.3k output, 23.9m cache read, 709.1k cache write ($19.16)
cashbit@Mac forecasto % 
